<!doctype html>
<html lang="ko"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="naver-site-verification" content="427d651b8544d9dd05f3baf8b71682504788ae7e"><title>카테고리: Node - 92Hz</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="92Hz"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="92Hz"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="website"><meta property="og:title" content="92Hz"><meta property="og:url" content="https://jongmin92.github.io/"><meta property="og:site_name" content="92Hz"><meta property="og:locale" content="ko_KR"><meta property="og:image" content="https://jongmin92.github.io/img/og_image.png"><meta property="article:author" content="KimJongMin"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://jongmin92.github.io"},"headline":"92Hz","image":["https://jongmin92.github.io/img/og_image.png"],"author":{"@type":"Person","name":"KimJongMin"},"description":""}</script><link rel="alternate" href="/rss2.xml" title="92Hz" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-90389042-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-90389042-1');</script><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><script data-ad-client="ca-pub-3921438651818825" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="92Hz" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="external nofollow noopener noreferrer" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="검색" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">카테고리</a></li><li><a href="/categories/Programming/">Programming</a></li><li class="is-active"><a href="#" aria-current="page">Node</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2017-08-11T09:00:00.000Z" title="8/11/2017, 6:00:00 PM">2017-08-11</time>&nbsp;게시 됨</span><span class="level-item"><time datetime="2021-03-21T11:06:34.430Z" title="3/21/2021, 8:06:34 PM">2021-03-21</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Node/">Node</a></span><span class="level-item">14분안에 읽기 (약 2148 단어)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/08/11/Node/check-in-app-billing-purchase-validation/">Android In-App Purchase Validation</a></h1><div class="content"><h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><ol>
<li><a href="#1">어떤 문제가 발생했는가?</a></li>
<li><a href="#2">Subscriptions and In-App Purchases API</a></li>
<li><a href="#3">API 사용을 위한 서비스 계정 연결</a></li>
<li><a href="#4">API 사용하기 (With node-iap)</a></li>
<li><a href="#5">마치며</a></li>
</ol>
<hr>
<p>얼마전 아랍어 번역을 마치고 몇개 국가에 앱을 출시하게 되면서 <strong><code>결제 관련</code></strong> 문제가 발생하기 시작했습니다. 앱과 서버의 결제 관련 코드를 모두 제가 맡아 작성했기 때문에 계속해서 발생하는 문제로 인해 정신적 충격이 상당했습니다…</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="http://theeye.pe.kr/archives/2130">“Android In-App Billing 보안 완벽 정리”</a>의 글을 참고해 결국에는 앱내 구매(In-App Billing)시 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://in-appstore.com/android/">프리덤(Freedom)</a>과 같은 **<code>결제 해킹 앱</code>**에 의해 문제가 발생하게 된다는것을 알게 되었습니다.</p>
<p>이에 서버에서 **<code>In-App Purchase Validation(앱내 구매 유효성 검사)</code>**을 하는 코드를 추가했고 위의 문제를 해결할 수 있었습니다. 이번 포스팅에서는 <strong>In-App Purchase Validation</strong>에 대해서 알아보겠습니다. (In-App 결제 구현에 대한 내용은 다루지 않습니다!)</p>
<hr>
<span id="1">
## 1. 어떤 문제가 발생했는가?

<p>어느날 이상한일이 벌어졌다. 분명 Admin을 통해 앱에서 결제한 내용을 확인했을때는 상당한 내역이 있었는데, <strong>Google Play Console의 주문 관리</strong>를 통해 확인했을 때는 결제 내역이 없는 것이다.</p>
<p>결제 관련된 부분에서 버그가 발생했기에 무척이나 마음이 심란했다. 반복되는 테스트에서도 재현할 수 없는 현상에 라이브 채팅을 통해 Google에 문의하였지만 돌아오는 답변은 사용자의 결제 관련 설정(예를들면 카드)이 잘못되어 있을 것이라는 말뿐, 정확한 해결 방법을 알려주지 않았다.</p>
<p>그러던 도중 결제 관련 DB를 살펴보다가 이상한 부분을 발견했다.</p>
<p><img src="/images/post/2017-08-11/purchase_log.jpg" alt="비정상적인 연속된 결제 내역"></p>
<p>**한명의 사람이 말도 안되는 짧은 시간에 한 품목을 여러변 결제한 것이다. 그리고 이 결제 관련 내용은 Google Play Console의 주문 관리에서도 확인이 불가능했다. (기록이 남지 않았다.) **</p>
<p>결국 글의 도입부에서 말씀드렸던 것처럼 결제 해킹 문제임을 알게되었고 In-App Purchase Validation에 대해 알아보게 되었습니다.</p>
<hr>
<span id="2">
## 2. Subscriptions and In-App Purchases API

<p>Google에서는 **<code>Subscriptions and In-App Purchases API</code>**를 제공하고 있습니다. (전에는 이 API를 “Purchase Status API” 라고 불렀습니다.)</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.android.com/google/play/developer-api.html?hl=ko#subscriptions_api_overview">Document</a>를 참고하면 해당 API를 <strong>인앱 상품과 구독으로 구성된 앱의 카탈로그를 관리할 수 있으며, 개별 구매에 대한 정보, 구매와 구독의 만료 확인 등, 여러 가지 용도로 사용할 수 있음을 알 수 있습니다.</strong></p>
<p>따라서 실제 결제가 이루어졌고, Google Play Console의 주문 관리에 그 내역이 있는지 확인이 가능한 것입니다. 해당 API는 Google Play Developer API로서 허용되는 사용 할당량이 <strong>매일 200,000개의 요청</strong>으로 제한됩니다. 이 정도면 충분한 구독, 결제 유효성 검사 요구를 충족시킬 수 있으며, 만약 더 많은 요청이 필요하다면 Google Developer Console에서 요청할 수 있다고 합니다.</p>
<hr>
<span id="3">
## 3. API 사용을 위한 서비스 계정 연결

<p>API를 사용하기 위해서는 Google Developer Console에서 서비스 계정을 생성한 후 API 엑세스 권한을 부여해주어야 합니다. 몇가지 단계를 거쳐야 하는데 같이 해보겠습니다.</p>
<p>1.<a target="_blank" rel="external nofollow noopener noreferrer" href="https://play.google.com/apps/publish/?hl=ko">Google Play Console</a>에 <strong>관리자 계정</strong>으로 로그인합니다.</p>
<p>2.<strong>설정 - API 액세스</strong>로 이동합니다. (서비스 약관은 수락합니다.)<br><img src="/images/post/2017-08-11/1.jpg"></p>
<p>3.<strong>새 프로젝트 만들기</strong> 후 하단의 <strong>서비스 계정 만들기</strong>를 선택합니다.<br><img src="/images/post/2017-08-11/2.jpg"></p>
<p>4.<strong>Google API 콘솔</strong>로 이동합니다.<br><img src="/images/post/2017-08-11/3.jpg"></p>
<p>5.<strong>서비스 계정 만들기</strong>를 선택한 후 다음과 같이 내용을 입력합니다.<br><img src="/images/post/2017-08-11/4.jpg"></p>
<p>6.서비스 계정을 생성하면 자동으로 <strong>.json 파일</strong>이 다운로드 됩니다. <strong>.json 파일에는 API 호출을 위한 인증 정보가 포함되어 있습니다. 관리 및 백업이 필요합니다.</strong></p>
<p>7.Google Play Console로 돌아와, 완료 버튼을 클릭한 후 서비스 계정이 생성되었는지 확인합니다.</p>
<p>8.<strong>엑세스 권한 부여</strong>를 클릭합니다.<br><img src="/images/post/2017-08-11/5.jpg"></p>
<p>9.역할을 <strong>금융</strong>으로 선택한 후, <strong>재무 데이터 보기</strong> 권한을 설정합니다.<br>(구매내역 및 영수증 검증을 하기 위해서는 재무 보고서 보기 권한이 필요합니다 . 역할을 금융으로 선택해 주면 해당 권한이 자동으로 선택됩니다. 영수증 검증을 위해서는 금융 역할을 갖는 서비스 계정이 필요합니다.)<br><img src="/images/post/2017-08-11/6.jpg"></p>
<hr>
<span id="4">
## 4. API 사용하기 (With node-iap)
복잡하게 토큰을 관리하며 HTTP/REST API를 사용할것 없이 **Google은 다양한 언어에 맞게 Client 라이브러리를 제공**하고 있습니다. [Access Google APIs more easily](https://developers.google.com/api-client-library/)를 통해서 다양한 언어의 라이브러리를 찾아 사용할 수 있습니다.

<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/google/google-api-nodejs-client/#google-apis-nodejs-client">google-api-nodejs-client</a>를 사용하면 되지만, **다른 Platform(apple)**에도 대응할 수 있는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Wizcorp/node-iap">node-iap(In-app purchase verification for Apple App Store and Google Play)</a>를 사용하겠습니다.</p>
<p>사용방법은 생각보다 정말 간단합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> iap = <span class="built_in">require</span>(<span class="string">&#x27;iap&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> platform = <span class="string">&#x27;google&#x27;</span>;</span><br><span class="line"><span class="keyword">let</span> payment = &#123;</span><br><span class="line">	receipt: <span class="string">&#x27;receipt data&#x27;</span>, <span class="comment">// always required (purchaseToken)</span></span><br><span class="line">	productId: <span class="string">&#x27;abc&#x27;</span>,</span><br><span class="line">	packageName: <span class="string">&#x27;my.app&#x27;</span>,</span><br><span class="line">	keyObject: <span class="string">&#x27;&#x27;</span>, <span class="comment">// always required (user auth key)</span></span><br><span class="line">	subscription: <span class="literal">false</span>,	<span class="comment">// optional, if google play subscription</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">iap.verifyPayment(platform, payment, <span class="function"><span class="keyword">function</span> (<span class="params">error, response</span>) </span>&#123;</span><br><span class="line">	<span class="comment">/* your code */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>node-iap는 google과 apple에서 모두 사용가능하기 때문에 platform을 명시해야 합니다. payment에는 확인하고자 하는 인앱결제 내역을 넣습니다.</p>
<p>Android In-App 결제를 하고나면 **<code>purchaseToken</code>**과 **<code>productId</code>**를 알 수 있습니다. payment의 receipt에는 purchaseToken 값을 넣습니다. productId와 packageName을 넣고 **<code>KeyObject</code>**에는 좀전에 사용자 계정을 추가하면서 다운로드 받았던 <strong>.json 파일</strong>의 값을 넣어주면 됩니다. (require 혹은 import하여 그대로 넣어주면 됩니다.)</p>
<p>Android 단말을 통해 테스트 결제 후 iap를 통해 purchase validation을 하면 다음과 같은 response를 얻을 수 있습니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;receipt&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;androidpublisher#productPurchase&quot;</span>,</span><br><span class="line">                <span class="string">&quot;purchaseTimeMillis&quot;</span>: <span class="string">&quot;1410835105408&quot;</span>,</span><br><span class="line">                <span class="string">&quot;purchaseState&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;consumptionState&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;developerPayload&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;transactionId&quot;</span>: <span class="string">&quot;ghbbkjheodjokkipdmlkjajn.AO-J1OwfrtpJd2fkzzZqv7i107yPmaUD9Vauf9g5evoqbIVzdOGYyJTSEMhSTGFkCOzGtWccxe17dtbS1c16M2OryJZPJ3z-eYhEJYiSLHxEZLnUJ8yfBmI&quot;</span>,</span><br><span class="line">        <span class="string">&quot;productId&quot;</span>: <span class="string">&quot;abc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;google&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>여기서 중요한 부분은 **<code>purchaseState</code>**의 값이 **<code>0</code>**이면 <strong>결제가 완료</strong>된 상태를 뜻하며 **<code>1</code>**이면 <strong>환불이 완료</strong>된 상태를 의미합니다.</p>
<p>만약 사용자가 제대로 된 결제를 하지 않는다면 purchaseToken 값은 유효하지 않아 purchase validation 과정에서 err가 발생할 것입니다.</p>
<hr>
<span id="5">
## 5. 마치며
굉장히 큰 문제라고 생각했지만 생각보다 조치하는 과정에 있어서 큰 어려움은 없었습니다. 아직 제가 더 생각하지 못한 부분이 있을수도 있을거라 생각합니다. 혹시나 더 추가해야 하는 부분이 있다면 알려주세요!

<p>저는 추가적으로 가짜 결제를 시도하는 유저들의 로그를 DB에 남기고 자동으로 block 처리를 해 게임을 못하도록 막았습니다. purchase validation 구현 후 바로 다음날 다시 또 가짜 결제가 이루어졌는데 유효성 검사가 제대로 이루어지는 것을 보고 정말 다행이라 생각했습니다.</p>
<p>제가 지금까지 회사에서 일하며 발생했던 가장 크리티컬했던 부분이라고 생각하는데 혹시나 이 글을 읽으시는 분중 아직 purchase validation을 하지 않고 계시다면 지금이라도 꼭 코드를 추가하셨으면 합니다.</p>
<hr>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.android.com/google/play/developer-api.html?hl=ko">Google Play Developer API</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://theeye.pe.kr/archives/2130">Android In-App Billing 보안 완벽 정리</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="http://theeye.pe.kr/archives/tag/purchasestate">Android In-App Billing 서버사이드 보안 완벽 정리</a></li>
</ul>
</span></span></span></span></span></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2017-07-13T09:43:00.000Z" title="7/13/2017, 6:43:00 PM">2017-07-13</time>&nbsp;게시 됨</span><span class="level-item"><time datetime="2021-03-21T11:06:43.447Z" title="3/21/2021, 8:06:43 PM">2021-03-21</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Node/">Node</a></span><span class="level-item">12분안에 읽기 (약 1861 단어)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/07/13/Node/require/">require는 어떻게 동작할까?</a></h1><div class="content"><h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><ol>
<li><a href="#1">Node.js의 모듈 로딩 시스템</a></li>
<li><a href="#2">require가 갖는 문제점</a></li>
<li><a href="#3">대 / 소문자 구분</a></li>
<li><a href="#4">NPM 모듈 종속성</a></li>
<li><a href="#5">마치며</a></li>
</ol>
<hr>
<p>Node.js를 사용하며 문득 require에 대해 궁금증이 생겼습니다. 대부분 자주 사용하는 코드를 모듈 형식으로 만들어 **<code>module.exports</code>**를 사용해서 객체 인스턴스를 내보내고 이를 다른 파일에서 **<code>require</code>**를 통해서 사용하게 되는데 대부분 <strong>여러 파일</strong>에서 모듈을 <strong>require</strong>해 사용하게 됩니다. 이때 여러파일에서 중복되는 require는 계속해서 새로운 인스턴스를 생성하는지, 그게 아니라면 어떻게 동작되는지 궁금해서 공부하며 찾아본 내용을 포스팅합니다.</p>
<hr>
<span id="1">
## 1. Node.js의 모듈 로딩 시스템

<p>Node.js는 간단한 모듈 로딩 시스템을 갖고 있습니다. Node.js에서 <strong>파일과 모듈은 일대일로 대응하며 각 파일은 별도의 모듈로 처리됩니다.</strong> 그렇기 때문에 여러곳에서 하나의 파일에 작성된 모듈을 필요로 할때 동일한 인스턴스를 사용할 수 있도록 합니다.</p>
<p>즉, 모듈을 require할 때마다 새로운 인스턴스가 생성되는 것이 아니라 <strong>캐싱된 객체 인스턴스를 재사용</strong>하는 것 입니다.</p>
<p>Node.js 공식 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://nodejs.org/api/globals.html#globals_require">Documentation</a>에서 확인할 수 있듯이 한번 로딩(require)된 모듈은 **<code>require.cache</code>**라는 객체에 캐싱됩니다. key값으로 <strong>해당 모듈 파일의 경로</strong>를 갖게 되는데 key값이 삭제된다면 다음 require 요청시 다시 재로딩 하게됩니다. 다음 코드를 통해서 require.cache에 캐싱된 모듈을 확인해보겠습니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foo.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  foo: <span class="string">&quot;bar&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="built_in">require</span>(<span class="string">&#x27;./foo&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;---------- require.cache ----------&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>.cache);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;---------- require.cache keys ----------&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.keys(<span class="built_in">require</span>.cache));</span><br></pre></td></tr></table></figure>

<p>foo.js 와 index.js 파일을 통해 확인한 결과는 다음과 같습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">kimjongmin:~&#x2F;work&#x2F;require_test $node index.js</span><br><span class="line"></span><br><span class="line">---------- require.cache ----------</span><br><span class="line">&#123; &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;index.js&#39;:</span><br><span class="line">   Module &#123;</span><br><span class="line">     id: &#39;.&#39;,</span><br><span class="line">     exports: &#123;&#125;,</span><br><span class="line">     parent: null,</span><br><span class="line">     filename: &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;index.js&#39;,</span><br><span class="line">     loaded: false,</span><br><span class="line">     children: [ [Object] ],</span><br><span class="line">     paths:</span><br><span class="line">      [ &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;node_modules&#39;,</span><br><span class="line">        &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;node_modules&#39;,</span><br><span class="line">        &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;node_modules&#39;,</span><br><span class="line">        &#39;&#x2F;Users&#x2F;node_modules&#39;,</span><br><span class="line">        &#39;&#x2F;node_modules&#39; ] &#125;,</span><br><span class="line">  &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;foo.js&#39;:</span><br><span class="line">   Module &#123;</span><br><span class="line">     id: &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;foo.js&#39;,</span><br><span class="line">     exports: &#123; foo: &#39;bar&#39; &#125;,</span><br><span class="line">     parent:</span><br><span class="line">      Module &#123;</span><br><span class="line">        id: &#39;.&#39;,</span><br><span class="line">        exports: &#123;&#125;,</span><br><span class="line">        parent: null,</span><br><span class="line">        filename: &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;index.js&#39;,</span><br><span class="line">        loaded: false,</span><br><span class="line">        children: [Object],</span><br><span class="line">        paths: [Object] &#125;,</span><br><span class="line">     filename: &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;foo.js&#39;,</span><br><span class="line">     loaded: true,</span><br><span class="line">     children: [],</span><br><span class="line">     paths:</span><br><span class="line">      [ &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;node_modules&#39;,</span><br><span class="line">        &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;node_modules&#39;,</span><br><span class="line">        &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;node_modules&#39;,</span><br><span class="line">        &#39;&#x2F;Users&#x2F;node_modules&#39;,</span><br><span class="line">        &#39;&#x2F;node_modules&#39; ] &#125; &#125;</span><br><span class="line">---------- require.cache keys ----------</span><br><span class="line">[ &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;index.js&#39;,</span><br><span class="line">  &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;foo.js&#39; ]</span><br></pre></td></tr></table></figure>

<p>위의 결과에서 확인할 수 있듯이 <strong><code>require.cache</code></strong> 객체는 key값으로 <strong>해당 모듈 파일의 경로</strong>를 사용해 모듈을 캐싱하고 있습니다.</p>
<hr>
<span id="2">
## 2. require가 갖는 문제점

<p>이제 require를 통해 모듈을 로딩할 경우 <strong>파일의 경로를 캐시 키로 사용</strong>하여 다른 여러 파일에서 동일한 파일을 필요로하는 경우 동일한 캐싱 된 모듈을 사용하는 것을 알게되었습니다.</p>
<p>이로인해 불필요한 메모리 사용을 피할 수 있습니다. 어찌보면 한번 로딩된 후 재사용되기 때문에 싱글 톤과 같이 동작한다고도 생각할 수 있습니다. 그러나 이러한 모듈의 캐싱 방식이 다음과 같이 제대로 동작하지 않는 경우가 있습니다.</p>
<ul>
<li>파일 이름의 잘못된 대 / 소문자 사용</li>
<li>다른 모듈이 NPM에서 동일한 모듈을 설치할 때</li>
</ul>
<hr>
<span id="3">
## 3. 대 / 소문자 구분

<p><strong>Windows 및 macOS는 기본적으로 파일 시스템에서 대 / 소문자를 구분하지 않습니다.</strong> 따라서 “foo.js” 라는 파일과 “FOO.js” 라는 파일을 검색 할 경우, 이 두 검색은 실제 파일 이름의 대소 문자와 상관없이 같은 폴더에서 동일한 파일을 찾습니다.</p>
<p>그러나 <strong>Node.js에서는 대/ 소문자를 구별하기 때문에 파일 이름을 두 개의 개별 모듈로 취급</strong>하므로 “foo.js”와 “FOO.js”가 같은 파일이라는 것을 알지 못합니다.</p>
<p>이 때문에 Windows와 macOS 모두에서 require 호출의 객체 캐시를 쉽게 파기 할 수 있습니다. 다음의 예시 코드에서 쉽게 확인할 수 있습니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foo.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  foo: <span class="string">&quot;bar&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = <span class="built_in">require</span>(<span class="string">&#x27;./foo&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> FOO = <span class="built_in">require</span>(<span class="string">&#x27;./FOO&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;---------- require.cache keys ----------&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.keys(<span class="built_in">require</span>.cache));</span><br><span class="line"></span><br><span class="line">FOO.foo = <span class="string">&#x27;different bar&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;---- foo object ----&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(foo, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;---- FOO object ----&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(FOO, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;---- foo object ----&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(foo, <span class="literal">null</span>, <span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<p>결과는 다음과 같습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kimjongmin:~&#x2F;work&#x2F;require_test $node index.js</span><br><span class="line"></span><br><span class="line">---------- require.cache keys ----------</span><br><span class="line">[ &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;index.js&#39;,</span><br><span class="line">  &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;foo.js&#39;,</span><br><span class="line">  &#39;&#x2F;Users&#x2F;kimjongmin&#x2F;work&#x2F;require_test&#x2F;FOO.js&#39; ]</span><br><span class="line">---- foo object ----</span><br><span class="line">&#123;</span><br><span class="line">  &quot;foo&quot;: &quot;bar&quot;</span><br><span class="line">&#125;</span><br><span class="line">---- FOO object ----</span><br><span class="line">&#123;</span><br><span class="line">  &quot;foo&quot;: &quot;different bar&quot;</span><br><span class="line">&#125;</span><br><span class="line">---- foo object ----</span><br><span class="line">&#123;</span><br><span class="line">  &quot;foo&quot;: &quot;bar&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>결과에서 확인 가능하듯이 require된 모듈은 key값으로 <strong>해당 모듈 파일의 경로</strong>를 사용해 캐싱되고 있습니다. require시 대 / 소문자를 구분해 key로 사용하기 때문에 2개의 객체가 생성되었으나, 결과적으로는 파일 시스템에 도달하면 같은 파일이 2번 반환된 것입니다. 즉, 같은 파일에 서로 다른 모듈로 2개가 생성되어 있는 것 입니다.</p>
<p>require 문에 파일 이름을 잘못 입력 한 것과 관련된 다른 문제도 있습니다. 대 / 소문자를 구분하는 파일 시스템에 배포하는 경우 실제 파일과 동일하게 처리되지 않은 버전은 파일을 찾지 못합니다.</p>
<hr>
<span id="4">
## 4. NPM 모듈 종속성

<p>모듈 캐싱이 제대로 작동하지 않는 상황은 NPM에서 둘 이상의 **<code>모듈 종속성이 같은 모듈을 설치</code>**할 때 입니다. 즉, 프로젝트가 NPM의 “Foo”와 “Bar”에 의존하고 Foo와 Bar가 둘 다 “Baz”에 의존하면 NPM (버전 2 이하)은에 의존하는 각 모듈에 대해 “Baz”의 다른 사본을 설치합니다.</p>
<p><strong><code>NPM 버전 3</code></strong> 에서는 종속성 목록을 병합하여 문제를 해결하고 있습니다. Foo와 Bar가 둘 다 동일한 Baz의 버전에 의존하면 하나의 사본만 설치합니다.</p>
<p>그러나, Foo와 Bar가 Baz의 서로 다른 (서로 호환되지 않는) 버전을 사용한다면, 여전히 두 버전을 모두 설치하며, 이 경우 모듈 캐시를 공유하지 않습니다.</p>
<hr>
<span id="5">
## 5. 마치며

<p>반복되는 코드를 모듈화 하거나 각 기능 별로 모듈화 하게되면 결국 다른 파일에서 require를 통해 사용하게 되는데, 이때마다 어떤식으로 동작하게 되는지 궁금했었습니다. 이번 포스팅을 작성하면서 이에 대한 궁금증을 해결할 수 있었고, 결과적으로 한번 로딩된 모듈은 캐싱되어 사용되기 때문에 각기 파일마다 require를 많이 한다고해서 크게 걱정할 필요는 없을 것 같습니다.</p>
<p>또한, 필요에 의해 (필요한 상황이 있을지 모르겠지만…) require.cache에 고의적으로 캐싱된 모듈을 지우고 다시 새로 로딩하여 사용할 수도 있을것 같습니다.</p>
</span></span></span></span></span></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2017-04-07T15:00:00.000Z" title="4/8/2017, 12:00:00 AM">2017-04-08</time>&nbsp;게시 됨</span><span class="level-item"><time datetime="2021-03-21T11:06:45.683Z" title="3/21/2021, 8:06:45 PM">2021-03-21</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Node/">Node</a></span><span class="level-item">16분안에 읽기 (약 2431 단어)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/04/08/Node/sequelize/">Sequelize 사용하기</a></h1><div class="content"><h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><ol>
<li><a href="#1">ORM 이란?</a></li>
<li><a href="#2">Sequelize 설치하기</a></li>
<li><a href="#3">Sequelize CLI 사용하기</a></li>
<li><a href="#4">Sequelize config 설정하기</a></li>
<li><a href="#5">Model 정의하기</a></li>
<li><a href="#6">Sequelize Sync 사용하기</a></li>
<li><a href="#7">Sequelize 예제 (SELECT)</a></li>
<li><a href="#8">Sequelize 예제 (INSERT)</a></li>
<li><a href="#9">Sequelize 예제 (UPDATE)</a></li>
<li><a href="#10">Sequelize 예제 (DELETE)</a></li>
</ol>
<hr>
<span id="1">
## ORM 이란?
**관계형 데이터베이스(RDB)**를 사용할때 데이터베이스의 데이터 조작(CRUD)를 위해서는 **SQL 문**을 작성해야합니다. SQL 문은 비즈니스 로직을 구성하고 있는 코드와 함께 작성하게 되는데 이는 코드의 가독성을 떨어뜨릴뿐만 아니라, 사용하는 관계형 데이터베이스에 따라 조금씩의 차이가 존재하기 때문에 문제가 발생할 수 있습니다. 이를 해결하기 위해 ORM을 사용합니다.

<p>**<code>ORM(Object Relational Mapping)</code>**은 객체(Object)와 관계(Relation)를 맵핑(Mapping)하여 <strong>비즈니스 로직에 집중</strong>할 수 있도록 데이터 처리 로직을 추상화시킵니다.</p>
<p>객체와 관계를 매핑한다는 것은 <strong>데이터베이스에 저장된 레코드를 객체로 바꿔표현한다는 의미</strong>하며, 비즈니스 로직에 집중할 수 있도록 데이터 처리 로직을 추상화한다는 것은 쿼리를 사용하지 않고도 데이터베이스를 사용할 수 있음을 뜻합니다.</p>
<p>ORM을 사용할 경우 특정 DBMS에 종속되지 않으며 생산성, 독립성, 가독성(SQL문이 코드에 들어가지 않기때문) 및 유지보수 측면에서의 장점이 있지만 반대로 RAW query에 비해 퍼포먼스가 떨어지고, query가 복잡해 질수록 오히려 생산성이 저하될 수 있다는 단점도 존재합니다.</p>
<p><img src="/images/post/2017-04-08/orm.png" alt="ORM"></p>
<hr>
<span id="2">
## Sequelize 설치하기
**[Sequelize](http://docs.sequelizejs.com/en/v3/)**는 Node에서 가장 많이 사용되는 ORM 입니다.

<p><strong>RDS로  PostgresSQL, MySQL, MariaDB, SQLite, MSSQL</strong>을 지원하고 transaction, read replication등 다양한 기능을 제공하고 있으며. 또한 <strong>Promise</strong>를 기본으로 동작하기 때문에 비동기 코드를 보기좋게 작성할 수 있습니다.</p>
<p>실습을 위해 express-generator를 통해 Express 프로젝트를 생성후 <code>sequelize</code>와 <code>mysql</code> module을 설치합니다. (Express 프로젝트를 생성하는 부분은 생략합니다.)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save sequelize mysql</span><br></pre></td></tr></table></figure>

<p>**<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/sequelize/cli">Sequelize Command Line Interface(CLI)</a>**를 사용하기 위해서 <code>sequelize-cli</code> module을 설치합니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g sequelize-cli</span><br></pre></td></tr></table></figure>

<hr>
<span id="3">
## Sequelize CLI 사용하기
**sequelize cli**를 통해서 **`migration(마이그레이션), seeder(시더), model(모델)`**의 초기 설정을 손쉽게 할 수 있습니다. 이번 포스팅에서는 **model**에 관해서 알아보겠습니다.

<p>RDB의 테이블을 model로 정의를 하면 해당 model을 통해 데이터 처리가 가능하게 됩니다.<br>먼저 생성한 express 프로젝트에 sequelize cli 명령어를 통해 sequelize 설정 파일을 생성 후 model을 정의해 보겠습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sequelize init:config --config config&#x2F;sequelize.json</span><br><span class="line">sequelize init:models</span><br></pre></td></tr></table></figure>

<p>sequelize cli의 <strong>sequelize init:config</strong>라는 명령어로 sequelize관련 config 파일을 자동으로 생성할 수 있습니다. 아무런 옵션을 주지 않는다면 <strong>config/config.json</strong> 파일이 생성됩니다.</p>
<p><strong>sequelize init:models</strong> 명령어를 통해서는 models 정의에 관련된 기본 구조를 생성할 수 있습니다.</p>
<p>위 2개의 명령어를 실행하면 다음과 같은 폴더와 파일이 생성됩니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── config&#x2F;</span><br><span class="line">  └── sequelize.json</span><br><span class="line">├── models&#x2F;</span><br><span class="line">  └── index.js</span><br></pre></td></tr></table></figure>

<hr>
<span id="4">
## Sequelize config 설정하기
sequelize cli를 통해 생성한 `config/sequelize.json`파일에 데이터베이스에 관련된 설정 값을 입력합니다.

<p> <strong><code>NODE_ENV</code></strong> 에 따라 각기 다른 값을 사용하기 때문에 상황에 맞게 설정할 수 있습니다. NODE_ENV에 대해 잘 알지 못한다면 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://inspiredjw.com/entry/Nodejs-%EC%97%90%EC%84%9C-NODEENV-%EA%B0%92%EC%9C%BC%EB%A1%9C-%ED%99%98%EA%B2%BD-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0">이곳</a>을 참고하세요.</p>
<p>데이터베이스를 사용한 프로젝트 경험이 있다면 대부분의 config 값은 입력할 수 있습니다. config 값중 <code>dialect</code>에는 사용하는 RDB 이름을 입력해야 합니다. diaect에 사용 가능한 값은 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://docs.sequelizejs.com/en/1.7.0/docs/usage/">sequelize docs</a>를 참고하세요. 현재 사용 가능한 RDB 로는 ‘mysql’, ‘sqlite’, ‘postgress’, ‘mariadb’가 있습니다.</p>
<p>추가적으로 커넥션 풀과 로깅 기능을 사용한다면 해당 값을 추가합니다. 추가적으로 필요한 옵션은 docs를 참고하세요.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;pool&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max&quot;</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="string">&quot;min&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;idle&quot;</span>: <span class="number">5000</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;logging&quot;</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<hr>
<span id="5">
## # Model 정의하기
Model을 생성하기 전 sequelize cli를 통해 생성한 `models/index.js`파일을 살펴보겠습니다. index.js 의 역할은 **config/sequelize.json**의 설정값을 읽어 sequelize를 생성한 후 **models 폴더** 아래에 정의한 model 관련 js 파일을 모두 로딩하여 db 객체에 Model을 정의한 후 반환합니다.

<p>sequelize config 관련 파일을 sequelize.json으로 생성하였다면 config 파일을 불러오는 <strong>require 부분의 경로를 수정</strong>해주어야 합니다.</p>
<p>이제 models 폴더 아래에 간단한 모델을 정의해 보겠습니다. **<code>user.js</code>**를 생성 후 다음의 코드를 입력합니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">sequelize, DataTypes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> user = sequelize.define(<span class="string">&#x27;User&#x27;</span>, &#123;</span><br><span class="line">    userID: &#123; <span class="attr">field</span>: <span class="string">&#x27;user_id&#x27;</span>, <span class="attr">type</span>: DataTypes.STRING(<span class="number">50</span>), <span class="attr">unique</span>: <span class="literal">true</span>, <span class="attr">allowNull</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    password: &#123; <span class="attr">field</span>: <span class="string">&#x27;password&#x27;</span>, <span class="attr">type</span>: DataTypes.STRING(<span class="number">30</span>), <span class="attr">allowNull</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="comment">// don&#x27;t use camelcase for automatically added attributes but underscore style</span></span><br><span class="line">    <span class="comment">// so updatedAt will be updated_at</span></span><br><span class="line">    underscored: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// disable the modification of tablenames; By default, sequelize will automatically</span></span><br><span class="line">    <span class="comment">// transform all passed model names (first parameter of define) into plural.</span></span><br><span class="line">    <span class="comment">// if you don&#x27;t want that, set the following</span></span><br><span class="line">    freezeTableName: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// define the table&#x27;s name</span></span><br><span class="line">    tableName: <span class="string">&#x27;user&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Sequelize 참고</span></span><br><span class="line"><span class="comment"> DataTypes =&gt; http://docs.sequelizejs.com/en/v3/api/datatypes/</span></span><br><span class="line"><span class="comment"> Associations =&gt; http://docs.sequelizejs.com/en/v3/api/associations/</span></span><br><span class="line"><span class="comment"> Model Function =&gt; http://docs.sequelizejs.com/en/v3/api/model/</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>Model을 생성하며 사용된 옵션은 주석과 docs를 참고합니다. 이제 모델에 대한 정의가 끝났습니다. 데이터베이스에 <strong>user</strong>라는 테이블은 <strong>User</strong>라는 Object로 매핑되었고 <strong>user_id, password</strong>라는 칼럼은 User Object의 속성으로 매핑되었습니다.</p>
<hr>
<span id="6">
## Sequelize Sync 사용하기
Sequeliz에서는 **입력(INSERT), 수정(UPDATE), 조회(SELECT), 삭제(DELETE)**의 **`데이터 조작(DML: Data Manipulation Language)`**뿐만 아니라 데이터베이스의 **스키마 객체를 생성(CREATE), 변경(ALERT), 제거(DROP)** 할 수 있는 **`데이터 정의(DDL: Data Definition Language)`**도 지원합니다.
따라서 이미 만들어진 데이터베이스 테이블에 모델을 매핑할 수 있을 뿐만 아니라, **정의한 모델을 바탕으로 테이블을 생성할 수도 있습니다.(동기화)**

<p>해당 기능을 사용하기 위해서는 Sequelize의 <strong><code>sync</code></strong> 메서드를 사용합니다. **<code>app.js</code>**에 다음의 코드를 추가합니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connect To DB</span></span><br><span class="line"><span class="keyword">const</span> models = <span class="built_in">require</span>(<span class="string">&#x27;./models&#x27;</span>);</span><br><span class="line">models.sequelize.sync()</span><br><span class="line">  .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;✓ DB connection success.&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;  Press CTRL-C to stop\n&#x27;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;✗ DB connection error. Please make sure DB is running.&#x27;</span>;</span><br><span class="line">    process.exit();</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>sync 메서드를 호출하여 실패했을 경우에는 에러 메시지를 출력 후 프로세스를 종료합니다.</p>
<p>sync 메서드는 모델에서 정의한 이름의 테이블이 존재하지 않을 경우에만 동작합니다. 이미 테이블이 존재할 경우에는 <strong><code>models.sequelize.sync(&#123;force: true&#125;)</code></strong> 과 같이 force 옵션을 주어 강제적으로 테이블을 제거 후 다시 생성이 가능하지만 매우 위험한 옵션이므로 주의를 기울여 사용해야 합니다.</p>
<hr>
<span id="7">
## Sequelize 예제 (SELECT)
이제 Sequelize를 사용하여 SELECT를 사용해보겠습니다. 유저 리스트를 가져오는 query는 다음과 같습니다.
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">models.User.findAll()</span><br><span class="line">  .then(results) &#123;</span><br><span class="line">     res.json(results);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
User 테이블에 있는 모든 row를 가져오는 query입니다. Sequelize는 결과를 Promise로 리턴하기 때문에 **`findAll`** 메서드 역시 Promise를 리턴합니다. 따라서 query의 결과는 then에서 받고, catch문에서 상황에 맞게 error 처리(handling)를 하면됩니다.

<p>findAll의 더 자세한 사용법은 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://sequelize.readthedocs.io/en/latest/api/model/#findalloptions-promisearrayinstance">Sequelize-model-findAll 설명</a>을 참고합니다.</p>
<hr>
<span id="8">
## Sequelize 예제 (INSERT)
Sequelize를 사용하여 INSERT를 하는 방법은 다음과 같습니다.
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">models.User.create(&#123;<span class="attr">userID</span>: <span class="string">&#x27;유저ID&#x27;</span>, <span class="attr">password</span>: <span class="string">&#x27;유저PW&#x27;</span>&#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">     res.json(result);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
**`create`** 메서드의 매개변수에 model에서 매핑한 내용을 토대로 데이터를 넣으면 query를 실행 후 insert된 row정보가 반환됩니다.

<p>create의 더 자세한 사용법은 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://sequelize.readthedocs.io/en/latest/api/model/#createvalues-options-promiseinstance">Sequelize-model-create 설명</a>을 참고합니다.</p>
<hr>
<span id="9">
## Sequelize 예제 (UPDATE)
User 테이블의 데이터를 수정할때는 다음과 같이 사용합니다.
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">models.User.update(&#123;<span class="attr">password</span>: <span class="string">&#x27;새로운 유저PW&#x27;</span>&#125;, &#123;<span class="attr">where</span>: &#123;<span class="attr">userID</span>: <span class="string">&#x27;유저ID&#x27;</span>&#125;&#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">     res.json(result);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
**`update`** 메서드의 매개변수에는 update할 데이터를 입력합니다.

<p>update 더 자세한 사용법은 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://sequelize.readthedocs.io/en/latest/api/model/#updatevalues-options-promisearrayaffectedcount-affectedrows">Sequelize-model-update 설명</a>을 참고합니다.</p>
<hr>
<span id="10">
## Sequelize 예제 (DELETE)
User 테이블의 데이터를 삭제할때는 다음과 같이 사용합니다.
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">models.User.destroy(&#123;<span class="attr">where</span>: &#123;<span class="attr">userID</span>: <span class="string">&#x27;유저ID&#x27;</span>&#125;&#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">     res.json(&#123;&#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
**`destroy`** 메서드의 매개변수에는 where 조건을 입력합니다.**(where 조건을 입력하지 않을 경우 테이블의 모든 row가 삭제되기 때문에 주의해야 합니다.)**

<p>destroy 더 자세한 사용법은 <a target="_blank" rel="external nofollow noopener noreferrer" href="http://sequelize.readthedocs.io/en/latest/api/model/#destroyoptions-promiseinteger">Sequelize-model-update 설명</a>을 참고합니다.</p>
</span></span></span></span></span></span></span></span></span></span></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2016-09-19T15:00:00.000Z" title="9/20/2016, 12:00:00 AM">2016-09-20</time>&nbsp;게시 됨</span><span class="level-item"><time datetime="2021-03-21T11:06:41.121Z" title="3/21/2021, 8:06:41 PM">2021-03-21</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Node/">Node</a></span><span class="level-item">8분안에 읽기 (약 1225 단어)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/09/20/Node/nvm-(Node-Version-Manager)/">NVM (Node Version Manager) 사용하기</a></h1><div class="content"><h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><ol>
<li><a href="#1">NVM (Node Version Manager)</a></li>
<li><a href="#2">NVM 사용시 이점</a></li>
<li><a href="#3">NVM 설치</a></li>
<li><a href="#4">NVM 명령어</a></li>
<li><a href="#5">모듈 설치</a></li>
<li><a href="#6">기존에 설치되어 있던 Node 제거</a></li>
</ol>
<hr>
<p>오늘은 NVM에 대해서 알아보겠습니다. 저는 회사에서 Ionic 을 통해서 하이브리드 앱을 개발하고 있습니다. Ionic의 개발환경은 기본적으로 Node.js를 필요로 합니다. 당시 처음 입사하였을때는 회사에서 사용중인 Node v4.4.0을 설치하여 사용하고 있었습니다. 그러나 후에 여러개의 프로젝트를 하며 ES6 문법을 사용하기 위해 상위 버전의 Node를 사용해야하 하는 일이 생겼습니다. 이런 경우 보통 Node를 제거한 후 상위 버전을 사용하게 된다면 후에 다시 Ionic 프로젝트를 할때 문제가 됩니다. 이럴때 NVM을 사용한다면 여러개의 Node 를 버전별로 쉽게 관리하고 사용할 수 있습니다. 지금부터 NVM을 사용했을때의 이점과 설치 및 사용방법에 대해 알아보겠습니다.</p>
<span id="1">
## NVM (Node Version Manager)
[NVM](https://github.com/creationix/nvm)은 말 그대로 Node의 버전을 관리해주는 매니저입니다. Ruby에는 RVM이 있듯이 Node에서는 NVM을 사용합니다. 한 사용자 계정에 여러개의 Node 버전을 설치하여 선택하여 사용할 수 있습니다.

<span id="2">
### NVM 사용시 이점
- 여러 버전의 Node를 쉽게 사용할 수 있습니다. (기존의 버전을 삭제할 필요가 없습니다.)
- NVM을 사용하지 않고 설치한 Node는 `/usr/local/bin/` 경로에 설치되지만 NVM을 사용하여 설치했을 경우에는 `/User/kimjongmin/.nvm/versions/node/` 경로에 설치됩니다. NVM을 사용했을 경우 사용자의 종속되어 설치되기 때문에 npm을 통하여 모듈을 설치할 때도 기존과는 달리 `-g` 옵션을 주지 않아도 설치 가능합니다. (npm또한 Node와 같이 설치되기 때문에 Node 버전마다 다르게 설치됩니다.)
- Node 버전에 따라 npm도 다르게 설치되기 때문에 모듈의 버전들도 각기 다르게 관리할 수 있습니다. 예를들어, Node v4.4.0 에서는 cordova v5.7.1을 Node v6.6.0 에서는 cordova v6.1.1을 설치하여 사용할 수 있습니다.

<span id="3">
### NVM 설치
NVM 설치전 기존에 설치되어 있던 Node를 제거하는것을 권장하지만 NVM 설치 후 제거하여도 괜찮습니다.

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl을 이용하여 설치</span><br><span class="line">$ curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.31.4/install.sh | bash</span><br></pre></td></tr></table></figure>

<p>설치 후 PATH 정보는 <code>.bashrc</code>에 저장되므로 재로그인 없이 사용하려면 변경된 <code>.bashrc</code>를 다시 적용시켜주어야 합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<span id="4">
### NVM 명령어
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 현재 최신 버전의 Node 설치 (별도의 버전을 지정하지 않고 현재 최신 버전으로 설치합니다.)</span><br><span class="line">$ nvm install node</span><br><span class="line">$ node -v (버전확인)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 설치된 Node 특정 버전 삭제하기</span><br><span class="line">$ nvm uninstall v4.4.0</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">// 설치된 Node는 ~/.nvm/versions/ 경로에서 확인 가능합니다.</span><br><span class="line">$ <span class="built_in">which</span> node</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// NVM에서 지원하는 Node의 버전을 확인할 수 있습니다.</span><br><span class="line">$ nvm ls-remote</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 특정 Node 버전 설치는 다음과 같이 가능합니다.</span><br><span class="line">$ nvm install v4.4.0</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 설치되어 사용가능한 Node 버전 확인</span><br><span class="line">$ nvm ls</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 특정 Node 버전 사용</span><br><span class="line">$ nvm use v6.6.0</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 터미널 시작시 노드 기본버전 설정</span><br><span class="line">$ nvm <span class="built_in">alias</span> default v6.6.0</span><br></pre></td></tr></table></figure>

<p><strong>Tip) 자주쓰는 명령어 alias 등록하기</strong><br>저는 NVM을 통해 Node v4.4.0과 v6.6.0을 설치하여 사용하고 있습니다. 프로젝트마다 Node 버전이 달라 프로젝트 변경시 Node의 버전도 변경해 주어야 하는 번거로움이 있어 <code>~.bash_custom</code>에 alias 로 등록하여 사용하고 있습니다. <code>(~.bashrc, ~.bash_profile )</code> 저는 다음과 같이 사용합니다. (파일에 추가 후 source 명령어로 변경된 파일을 적용하거나 새로운 쉘을 열어야 적용됩니다.)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> nv=<span class="string">&#x27;node -v&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> n4=<span class="string">&#x27;nvm use v4.4.0&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> n6=<span class="string">&#x27;nvm use v6.6.0&#x27;</span></span><br></pre></td></tr></table></figure>

<span id="5">
### 모듈 설치
NVM use 명령어를 통해 원하는 Node 버전을 선택 후 npm install 을 통해 필요한 모듈을 설치할 수 있습니다. 기존 사용법과 동일하나 NVM 은 `/User`에 설치되기 때문에 더이상 sudo 명령어를 사용하지 않아도 됩니다. 또한 하나의 Node 버전에서 필요한 모듈을 설치 후 새로운 Node 버전을 생성할 때 특정 버전 npm 패키지를 마이그레이션 할 수 있습니다.
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nvm install v6.6.0 --reinstall-packages-from=4.4.0</span><br></pre></td></tr></table></figure>

<span id="6">
### 기존에 설치되어 있던 Node 제거
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rm -rf /usr/<span class="built_in">local</span>/lib/node /usr/<span class="built_in">local</span>/lib/node_modules /var/db/receipts/org.nodejs.*</span><br></pre></td></tr></table></figure>
</span></span></span></span></span></span></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2016-08-24T15:00:00.000Z" title="8/25/2016, 12:00:00 AM">2016-08-25</time>&nbsp;게시 됨</span><span class="level-item"><time datetime="2021-03-21T11:06:38.593Z" title="3/21/2021, 8:06:38 PM">2021-03-21</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Node/">Node</a></span><span class="level-item">5분안에 읽기 (약 722 단어)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/08/25/Node/module-exports_exports/">module.exports와 exports 차이 이해하기</a></h1><div class="content"><h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><ol>
<li><a href="#1">모듈이란?</a></li>
<li><a href="#2">모듈 추출하기(exporting)</a></li>
<li><a href="#3">모듈 사용하기(importing)</a></li>
<li><a href="#4">중요 포인트</a></li>
</ol>
<hr>
<span id="1">
## 모듈이란?
`모듈`이란 **관련된 코드들을 하나의 코드 단위로 캡슐화** 하는 것을 말합니다. Node.js 에서 예시를 살펴보겠습니다.
다음과 같은 `greeting.js` 라는 파일이 있습니다. **이 파일은 두개의 함수를 포함**하고 있습니다.
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// greetings.js</span></span><br><span class="line">sayHelloInEnglish = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">sayHelloInSpanish = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&quot;Hola&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<span id="2">
## 모듈 추출하기(exporting)
`gretting.js` 의 코드가 다른 파일에서 사용될 때 그 **효용성이 증가**할 것입니다. 이러한 일을 하기 위해서는 다음과 같은 `3가지의 단계`를 거쳐야 합니다.

<p>1.<code>greeting.js</code> 파일의 코드 첫 부분에 다음과 같은 코드가 존재해야 합니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// greetings.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="built_in">exports</span> = <span class="built_in">module</span>.exports = &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>2.다른 파일에서 exports 객체를 사용하기를 원한다면 greeting.js 파일에서 다음과 같이 작성해야 합니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// greetings.js</span></span><br><span class="line"><span class="comment">// var exports = module.exports = &#123;&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.sayHelloInEnglish = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;HELLO&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">exports</span>.sayHelloInSpanish = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hola&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>위의 코드에서 exports 를 module.exports 로 대체할 수 있으며 같은 결과를 얻을 수 있습니다. 이 부분이 잘 이해가 가지 않는다면 exports 와 module.exports 가 같은 객체를 참조한다고 기억하기 바랍니다.</p>
<p>3.module.exports 의 현재 값은 다음과 같습니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    sayHelloInEnglish: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HELLO&quot;</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    sayHelloInSpanish: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hola&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<span id="3">
## 모듈 사용하기(importing)
`main.js` 라는 새로운 파일에서 `greeting.js` 의 메소드를 사용 할 수 있도록 **import** 하는 과정은 다음과 같습니다.

<p>1.먼저 <code>require</code>이라는 키워드는 Node.js 에서 module(모듈)을 import(추가) 하기 위해 사용합니다. require는 다음과 같이 정의되어 있습니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">require</span> = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>2.<code>main.js</code>에서 <code>greetings.js</code>를 require 합니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">var</span> greetings = <span class="built_in">require</span>(<span class="string">&quot;./greetings.js&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>위의 코드는 아래와 동일한 코드 입니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">var</span> greetings = &#123;</span><br><span class="line">    sayHelloInEnglish: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HELLO&quot;</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    sayHelloInSpanish: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hola&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>3.<code>main.js</code> 에서 <code>greeting.js</code> 의 값과 메소드에 접근할 수 있습니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">var</span> greetings = <span class="built_in">require</span>(<span class="string">&quot;./greetings.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;Hello&quot;</span></span><br><span class="line">greetings.sayHelloInEnglish();</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;Hola&quot;</span></span><br><span class="line">greetings.sayHelloInSpanish();</span><br></pre></td></tr></table></figure>

<hr>
<span id="4">
## 중요 포인트
require 키워드는 `object` 를 반환합니다. 그리고 module.exports 와 exports 는 `call by reference` 로 동일한 객체를 바라보고 있고, **리턴되는 값은 항상 module.exports** 입니다.

<p>모듈은 기본적으로 객체이고, 이 객체를 module.exports, exports 모두 바라보고 있는데, 최종적으로 return 되는 것은 무조건 module.exports 라는 것입니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.render(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;Express&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p>위의 소스는 다음과 같이 해석할 수 있습니다.<br>express.Router() 가 리턴한 “객체”에 일부 프로퍼티를 수정한 뒤, 이 객체 자체를 모듈로 리턴한 것입니다.</p>
</span></span></span></span></div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpeg" alt="JongMin"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">JongMin</p><p class="is-size-6 is-block">생각을 기록하자</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">포스트</p><a href="/archives"><p class="title">125</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">카테고리</p><a href="/categories"><p class="title">23</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">태그</p><a href="/tags"><p class="title">205</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/jongmin92" target="_blank" rel="external nofollow noopener noreferrer">팔로우</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="external nofollow noopener noreferrer" title="Github" href="https://github.com/jongmin92"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="external nofollow noopener noreferrer" title="Facebook" href="https://www.facebook.com/jongmin.kim.7796420"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">카테고리</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Algorithm/"><span class="level-start"><span class="level-item">Algorithm</span></span><span class="level-end"><span class="level-item tag">14</span></span></a><ul><li><a class="level is-mobile" href="/categories/Algorithm/BOJ/"><span class="level-start"><span class="level-item">BOJ</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Concept/"><span class="level-start"><span class="level-item">Concept</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Book/"><span class="level-start"><span class="level-item">Book</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Database/"><span class="level-start"><span class="level-item">Database</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">95</span></span></a><ul><li><a class="level is-mobile" href="/categories/Programming/AWS/"><span class="level-start"><span class="level-item">AWS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Git/"><span class="level-start"><span class="level-item">Git</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Gradle/"><span class="level-start"><span class="level-item">Gradle</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/HTML/"><span class="level-start"><span class="level-item">HTML</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/JavaScript/"><span class="level-start"><span class="level-item">JavaScript</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Linux-Ubuntu/"><span class="level-start"><span class="level-item">Linux &amp; Ubuntu</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Node/"><span class="level-start"><span class="level-item">Node</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/RaspberryPi/"><span class="level-start"><span class="level-item">RaspberryPi</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/React-Native/"><span class="level-start"><span class="level-item">React Native</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Spring/"><span class="level-start"><span class="level-item">Spring</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Tool/"><span class="level-start"><span class="level-item">Tool</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Project/"><span class="level-start"><span class="level-item">Project</span></span><span class="level-end"><span class="level-item tag">6</span></span></a><ul><li><a class="level is-mobile" href="/categories/Project/Emily/"><span class="level-start"><span class="level-item">Emily</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Tip/"><span class="level-start"><span class="level-item">Tip</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">최근 글</h3><article class="media"><div class="media-content"><p class="date"><time datetime="2021-03-20T15:17:42.000Z">2021-03-21</time></p><p class="title"><a href="/2021/03/21/Kotlin/coroutines/">코루틴 이해하기</a></p><p class="categories"><a href="/categories/Kotlin/">Kotlin</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-03-30T15:44:27.000Z">2020-03-31</time></p><p class="title"><a href="/2020/03/31/Java/use-assertthat/">Unit Test에서 AssertThat을 사용하자</a></p><p class="categories"><a href="/categories/Java/">Java</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2020-01-02T13:29:00.000Z">2020-01-02</time></p><p class="title"><a href="/2020/01/02/Java/rsa/">Encryption - RSA</a></p><p class="categories"><a href="/categories/Programming/">Programming</a> / <a href="/categories/Programming/Java/">Java</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2019-12-26T13:23:00.000Z">2019-12-26</time></p><p class="title"><a href="/2019/12/26/Programming/2019-retrospect/">2년차 LINE 서버 개발자의 2019년 회고</a></p><p class="categories"><a href="/categories/Programming/">Programming</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2019-12-23T14:37:00.000Z">2019-12-23</time></p><p class="title"><a href="/2019/12/23/Programming/hmac/">HMAC을 이용한 무결성 보장</a></p><p class="categories"><a href="/categories/Programming/">Programming</a></p></div></article></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">광고</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3921438651818825" data-ad-slot="3015269677" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="92Hz" height="28"></a><p class="is-size-7"><span>&copy; 2021 KimJongMin</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="external nofollow noopener noreferrer">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("ko");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="맨 위로" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="입력 하세요..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"입력 하세요...","untitled":"(제목 없음)","posts":"포스트","pages":"페이지","categories":"카테고리","tags":"태그"});
        });</script></body></html>