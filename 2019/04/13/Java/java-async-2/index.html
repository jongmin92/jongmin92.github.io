<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="XPweYu29qWs-CX2Byp48Y71yuYCDvBDkR8_PrVUy9UA">
    <meta name="naver-site-verification" content="4468fb67994f2c880ea59d43b7f9a03be45d43d8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/images/etc/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          비동기 RestTemplate과 비동기 MVC/Serlvet - 92Hz
        
    </title>

    <link rel="canonical" href="https://jongmin92.github.io/2019/04/13/Java/java-async-2/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- For SEO -->
    <link rel="canonical" href="https://jongmin92.github.io/2019/04/13/java/java-async-2/">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            /* 기본 포스트 헤더 이미지 (페이지 이미지 || 기본 헤더 이미지) */
            /* background-image: url('undefined') */
            /* background-image: url('/images/etc/home.jpg') */
            background-image: url('/images/etc/home.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header">
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Java" title="Java">Java</a>
                            
                              <a class="tag" href="/tags/#Async" title="Async">Async</a>
                            
                              <a class="tag" href="/tags/#DeferredResult" title="DeferredResult">DeferredResult</a>
                            
                              <a class="tag" href="/tags/#RestTemplate" title="RestTemplate">RestTemplate</a>
                            
                              <a class="tag" href="/tags/#AsyncRestTemplate" title="AsyncRestTemplate">AsyncRestTemplate</a>
                            
                              <a class="tag" href="/tags/#Netty" title="Netty">Netty</a>
                            
                        </div>
                        <h1>비동기 RestTemplate과 비동기 MVC/Serlvet</h1>
                        <h2 class="subheading">&lt;토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 비동기 RestTemplate과 비동기 MVC/Serlvet&gt; 정리</h2>
                        <span class="meta">
                            Posted by KimJongMin on
                            2019-04-13
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">92Hz</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <center>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3921438651818825" data-ad-slot="3015269677"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</center>

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=ExUfZkh7Puk" rel="external nofollow noopener noreferrer" target="_blank">토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 비동기 RestTemplate과 비동기 MVC/Serlvet</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p>
<p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다.</p>
<h1 id="thread-pool-hell">Thread Pool Hell</h1>
<p><strong><a href="https://jongmin92.github.io/2019/03/31/Java/java-async-1/#servlet-async">스프링의 비동기 기술</a></strong> 을 이용해 클라이언트로부터 요청을 받은 후 실제 작업은 작업 스레드 풀에 위임하고 현재의 서블릿 스레드는 서블릿 스레드 풀에 반환 후, 다음 요청이 들어올 경우 바로 사용할 수 있게 효율적으로 처리하도록 만들었습니다.<br>
그러나 아직 문제가 있습니다.</p>
<p>아주 빠르게 무언가를 계산하고 해당 처리를 끝내는 경우라면 굳이 비동기 MVC(서블릿)를 사용하지 않아도 문제가 없지만, <strong>하나의 요청에 대한 처리를 수행하면서 외부의 서비스들을 호출하는 작업이 많이 있는 경우, 문제는 단순히 비동기를 서블릿을 사용하는 것만으로 해결할 수 없는 경우가 많이 있습니다.</strong> (서블릿 요청은 바로 사용 가능하더라도 워커 스레드가 I/O 같은 작업으로 인해 블록되기 때문입니다.)</p>
<p><strong><code>Thread Pool Hell</code>이란 풀 안에 있는 스레드에 대한 사용 요청이 급격하게 증가해 추가적인 요청이 들어올 때, 사용 가능한 스레드 풀의 스레드가 없기 때문에 대기 상태에 빠져 요청에 대한 응답이 느려지게 되는 상태를 말합니다.</strong><br>
<img src="/images/post/2019-04-13/thread_pool_hell.png" alt="thread pool hell"></p>
<p>최근 서비스들은 아래의 그럼처럼 하나의 요청을 처리함에 있어 다른 서버로의 요청(Network I/O)이 많아졌습니다. 조금전 설명한 것처럼 비동기 서블릿을 사용하더라도 하나의 요청을 처리하는 동안 하나의 작업(워커) 스레드는 그 시간동안 대기상태에 빠지게 되어 결국에는 스레드 풀의 가용성이 떨어지게 됩니다. 이번 포스팅에서는 해당 문제를 해결해가는 과정을 다루고 있습니다.</p>
<p><img src="/images/post/2019-04-13/service_oriented_architecture.png" alt="service oriented architecture"></p>
<h1 id="upgrade-client-for-load-test">Upgrade Client (For Load Test)</h1>
<p>지난 번에 작성했던 Client를 조금 수정하도록 합니다. 기존의 Client는 100개의 스레드를 순차적으로 만들면서 서버로의 Request를 만들었던 문제가 있었습니다. 이제는 100개의 스레드를 만들고 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/CyclicBarrier.html" rel="external nofollow noopener noreferrer" target="_blank">CyclicBarrier</a>를 이용해 100개의 스레드에서 동시에 Request를 만들도록 변경해보겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        String url = <span class="string">"http://localhost:8080/rest?idx=&#123;idx&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">101</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// submit이 받는 callable은 return을 가질 수 있으며, exception도 던질 수 있다.</span></span><br><span class="line">            es.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">int</span> idx = counter.addAndGet(<span class="number">1</span>);</span><br><span class="line">                log.info(<span class="string">"Thread &#123;&#125;"</span>, idx);</span><br><span class="line">                barrier.await();</span><br><span class="line"></span><br><span class="line">                StopWatch sw = <span class="keyword">new</span> StopWatch();</span><br><span class="line">                sw.start();</span><br><span class="line"></span><br><span class="line">                String res = rt.getForObject(url, String.class, idx);</span><br><span class="line"></span><br><span class="line">                sw.stop();</span><br><span class="line">                log.info(<span class="string">"idx: &#123;&#125;, Elapsed: &#123;&#125; -&gt; res: &#123;&#125;"</span>, idx, sw.getTotalTimeSeconds(), res);</span><br><span class="line">                <span class="comment">// IDE가 funtional interface가 callable임을 인식할 수 있도록 의미없는 return을 넣어준다.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// await을 만난 스레드가 101번째가 될 때, 모든 스레드들도 await에서 풀려나 이후 로직을 수행한다. </span></span><br><span class="line">        <span class="comment">// 메인 스레드 1개, Executors.newFixedThreadPool로 생성한 스레드 100개</span></span><br><span class="line">        barrier.await();</span><br><span class="line">        StopWatch main = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        main.start();</span><br><span class="line"></span><br><span class="line">        es.shutdown();</span><br><span class="line">        <span class="comment">// 지정된 시간이 타임아웃 걸리기 전이라면 대기작업이 진행될 때까지 기다린다.</span></span><br><span class="line">        <span class="comment">// (100초안에 작업이 끝날때까지 기다리거나, 100초가 초과되면 종료)</span></span><br><span class="line">        es.awaitTermination(<span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">        main.stop();</span><br><span class="line">        log.info(<span class="string">"Total: &#123;&#125;"</span>, main.getTotalTimeSeconds());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="외부-서비스-호출-테스트">외부 서비스 호출 테스트</h1>
<p>클라이언트의 요청을 받아 외부 서비스를 호출하고 해당 결과를 이용해서 응답을 돌려주는 테스트를 진행합니다. 테스트를 진행하기 위해서는 2개의 스프링 애플리케이션이 필요합니다. 2개의 스프링 애플리케이션의 설정은 다음과 같습니다.</p>
<ul>
<li>Main Application
<ul>
<li>port: 8080</li>
<li>tomcat-max-thread-count: 1</li>
</ul>
</li>
<li>Remote Application
<ul>
<li>port: 8081</li>
<li>tomcat-max-thread-count: 1000</li>
</ul>
</li>
</ul>
<h2 id="main-application">Main Application</h2>
<p>먼저 하나의 스프링 애플리케이션에 컨트롤러를 하나 준비합니다. 이 컨트롤러는 클라이언트로부터 요청을 받아 해당 요청으로부터 받은 값을 이용해 다른 외부 서비스(<a href="http://localhost:8081/service?req=%7Breq%7D" rel="external nofollow noopener noreferrer" target="_blank">http://localhost:8081/service?req={req}</a>)를 호출합니다.</p>
<p><strong>결국 해당 서블릿은 클라이언트 요청을 처리하면서 외부 서비스로의 Networking I/O 작업을 수행하기 때문에 외부 서비스로부터의 요청에 대한 응답을 받기 전까지는 blocking 상태가 됩니다.</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            String res = rt.getForObject(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);        </span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>application.properties</code> 파일에서 다음과 같이 Tomcat의 스레드 개수를 1개로 설정합니다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.tomcat.max-threads=1</span></span><br></pre></td></tr></table></figure>
<h2 id="remote-application">Remote Application</h2>
<p>다른 하나의 스프링 애플리케이션을 생성하고 이전에 만들었던 스프링 애플리케이션의 컨트롤러 내부에서 만들었던 요청을 받아 처리할 수 있도록 컨트롤러 추가합니다. 8080 포트가 아닌 8081 포트를 사용하고 tomcat 스레드를 1000개로 설정합니다. RemoteApplication은 application.properties의 값을 사용하게 하지 않고 직접 프로퍼티를 설정해줍니다.</p>
<p>아래와 같이 설정하면 Intellij를 이용해서 하나의 프로젝트에서 2개의 스프링 애플리케이션을 실행할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 하나의 프로젝트에서 2개의 스프링 애플리케이션을 띄우기 위해 외부 서비스 역할을 하는 RemoteApplication은</span></span><br><span class="line">        <span class="comment">// application.properties가 아닌 별도의 프로퍼티를 이용하도록 직접 설정한다.</span></span><br><span class="line">        System.setProperty(<span class="string">"server.port"</span>, <span class="string">"8081"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"server.tomcat.max-threads"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        SpringApplication.run(RemoteApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="결과-확인">결과 확인</h2>
<p>MainApplication과 RemoteApplication을 각각 실행하고 Client를 이용한 테스트 결과는 다음과 같습니다.<br>
100개의 클라이언트 요청을 처리하는데 0.4초 정도의 시간이 걸렸습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] INFO com.example.study.LoadTest - idx: <span class="number">40</span>, Elapsed: <span class="number">0.4</span> -&gt; res: hello40/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] INFO com.example.study.LoadTest - idx: <span class="number">77</span>, Elapsed: <span class="number">0.401</span> -&gt; res: hello77/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] INFO com.example.study.LoadTest - idx: <span class="number">48</span>, Elapsed: <span class="number">0.403</span> -&gt; res: hello48/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.545</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.545</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.546</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] INFO com.example.study.LoadTest - idx: <span class="number">8</span>, Elapsed: <span class="number">0.407</span> -&gt; res: hello8/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] INFO com.example.study.LoadTest - idx: <span class="number">33</span>, Elapsed: <span class="number">0.409</span> -&gt; res: hello33/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">0.407</span></span><br></pre></td></tr></table></figure>
<p>이번에는 RemoteApplication의 요청 처리 부분에 2초간 Thread sleep을 주고 다시 한 번 클라이언트를 이용해 테스트를 진행해봅니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RemoteApplication</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">return</span> req + <span class="string">"/service"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Thread sleep을 추가하고 다시 테스트를 해보면 결과는 다음과 같습니다. 100개의 요청을 약 0.4초만에 모두 처리하던 이전과 달리 매 요청을 처리하는데 약 2초의 시간이 증가하고 있습니다. 결국 마지막 요청은 약 2 * 100 = 200초 후에서야 응답을 받을 수 있기 때문에 모든 요청에 대한 처리는 200초 정도 걸릴 것 입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.056</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.058</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.061</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] INFO com.example.study.LoadTest - idx: <span class="number">32</span>, Elapsed: <span class="number">2.233</span> -&gt; res: hello32/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] INFO com.example.study.LoadTest - idx: <span class="number">56</span>, Elapsed: <span class="number">4.231</span> -&gt; res: hello56/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] INFO com.example.study.LoadTest - idx: <span class="number">93</span>, Elapsed: <span class="number">6.238</span> -&gt; res: hello93/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] INFO com.example.study.LoadTest - idx: <span class="number">31</span>, Elapsed: <span class="number">8.249</span> -&gt; res: hello31/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.081</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.082</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.082</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] INFO com.example.study.LoadTest - idx: <span class="number">20</span>, Elapsed: <span class="number">10.254</span> -&gt; res: hello20/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] INFO com.example.study.LoadTest - idx: <span class="number">46</span>, Elapsed: <span class="number">12.26</span> -&gt; res: hello46/service</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>이런 결과가 나오게 된 이유는 클라이언트로부터의 요청을 받아 처리하는 Main Application의 tomcat thread가 1개이고, 1개의 서블릿 스레드를 이용해 클라이언트의 요청을 처리하는 과정에서 Remote Application에 대한 요청(Network I/O)에서 응답을 받기까지 약 2초간 스레드가 block되기 때문입니다.</p>
<h1 id="asyncresttemplate">AsyncRestTemplate</h1>
<p><strong>위의 문제는 MainApplication의 tomcat 스레드는 클라이언트의 요청을 처리하며 외부 서비스(RemoteApplication)로 요청(Network I/O)을 보낸 후, 응답이 올 때까지 대기하고 있는 상태라는 점입니다. 해당 시간동안 CPU는 아무 일을 처리하지 않기때문에 자원이 소모되고 있습니다.</strong></p>
<p><strong>이 문제를 해결하기 위해서는 API를 호출하는 작업을 비동기적으로 바꿔야합니다. tomcat 스레드는 요청에 대한 작업을 다 끝내기 전에 반환을 해서 바로 다음 요청을 처리하도록 사용합니다. 그리고 외부 서비스로부터 실제 결과를 받고 클라이언트의 요청에 응답을 보내기 위해서는 새로운 스레드를 할당 받아 사용합니다.</strong> (외부 서비스로부터 실제 결과를 받고 클라이언트에 응답을 보내기 위해서는 새로운 스레드를 할당 받아야 하지만, 외부 API를 호출하는 동안은 스레드(tomcat) 자원을 낭비하고 싶지 않다는 것이 목적이다.)</p>
<p>스프링 3.x 버전에서는 이 문제를 간단히 해결하기 어려웠지만 스프링 4 부터 제공하는 <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/AsyncRestTemplate.html" rel="external nofollow noopener noreferrer" target="_blank">AsyncRestTemplate</a>을 사용하면 이 문제를 쉽게 해결할 수 있습니다. <strong>AsyncRestTemplate은 비동기 클라이언트를 제공하는 클래스이며 ListenableFuture를 반환합니다. 스프링은 컨트롤러에서 ListenableFuture를 리턴하면 해당 스레드는 즉시 반납하고, 스프링 MVC가 자동으로 등록해준 콜백에 의해 결과가 처리됩니다.</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="keyword">public</span> ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; rest(<span class="keyword">int</span> idx) &#123;</span><br><span class="line">            <span class="keyword">return</span> rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>실행 결과를 살펴보면 100개의 요청을 동시에 처리하는데 약 2.6초의 시간이 걸렸습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.088</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.089</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.089</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.example.study.LoadTest - idx: <span class="number">4</span>, Elapsed: <span class="number">2.658</span> -&gt; res: hello4/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] INFO com.example.study.LoadTest - idx: <span class="number">44</span>, Elapsed: <span class="number">2.659</span> -&gt; res: hello44/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] INFO com.example.study.LoadTest - idx: <span class="number">93</span>, Elapsed: <span class="number">2.658</span> -&gt; res: hello93/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.095</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.096</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.096</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] INFO com.example.study.LoadTest - idx: <span class="number">66</span>, Elapsed: <span class="number">2.664</span> -&gt; res: hello66/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] INFO com.example.study.LoadTest - idx: <span class="number">16</span>, Elapsed: <span class="number">2.667</span> -&gt; res: hello16/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] INFO com.example.study.LoadTest - idx: <span class="number">57</span>, Elapsed: <span class="number">2.669</span> -&gt; res: hello57/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.104</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.104</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.example.study.LoadTest - idx: <span class="number">2</span>, Elapsed: <span class="number">2.674</span> -&gt; res: hello2/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] INFO com.example.study.LoadTest - idx: <span class="number">15</span>, Elapsed: <span class="number">2.674</span> -&gt; res: hello15/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.106</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.673</span></span><br></pre></td></tr></table></figure>
<p>클라이언트의 요청이 들어 올 때, MainApplication의 스레드 상태를 살펴보면, tomcat 스레드는 그대로 1개 입니다.(http-nio-8080-exec-1) 그러나 비동기 작업을 처리하기 위해서 순간적으로 백그라운드에 100개의 스레드 새로 생성되는것을 확인할 수 있습니다.<br>
<img src="/images/post/2019-04-13/async_rest_template_result.png" alt="async rest template result"></p>
<h1 id="netty-non-blocking-io">Netty non-blocking I/O</h1>
<p>지금까지 Tomcat의 스레드가 1개이지만 요청을 비동기적으로 처리함으로써 Tomcat의 스레드는 바로 반환이되어 다시 그 후의 요청에 Tomcat의 스레드를 이용해 요청을 받을 수 있었습니다. 그러나 결과적으로는 실제 비동기 요청을 처리하는 스레드는 요청의 수 만큼 계속 생성되는 것을 확인할 수 있었습니다.</p>
<p>이번에는 이렇게 <strong>비동기 요청을 처리하는 스레드의 수도 Netty의 non blocking I/O를 이용함으로써 비동기 요청을 처리하는 스레드도 줄여보고자 합니다.</strong> 그러면 결과적으로 tomcat의 스레드 1개, netty의 non blocking I/O를 이용하기위한 필요한 스레드의 수만큼만 생성되어 클라이언트의 요청을 모두 처리할 수 있을 것 입니다.</p>
<p>먼저 netty의 dependency를 build.gradle 혹은 pom.xml에 추가합니다. 저는 build.gradle에 의존성을 추가해 주었습니다.</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    implementation <span class="string">'io.netty:netty-all:4.0.4.Final'</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AsyncRestTemplate이 netty의 Netty4ClientHttpRequestFactory를 이용할 수 있도록 다음과 같이 설정합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="keyword">public</span> ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; rest(<span class="keyword">int</span> idx) &#123;</span><br><span class="line">            <span class="keyword">return</span> rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>다시 서버를 띄우고 테스트를 해보면 클라이언트의 요청을 전부 처리하는데 걸린 시간은 약 2.7초로 이전과 큰 차이가 없습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] INFO com.example.study.LoadTest - idx: <span class="number">65</span>, Elapsed: <span class="number">2.744</span> -&gt; res: hello65/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] INFO com.example.study.LoadTest - idx: <span class="number">59</span>, Elapsed: <span class="number">2.751</span> -&gt; res: hello59/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.965</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.965</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] INFO com.example.study.LoadTest - idx: <span class="number">14</span>, Elapsed: <span class="number">2.752</span> -&gt; res: hello14/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] INFO com.example.study.LoadTest - idx: <span class="number">31</span>, Elapsed: <span class="number">2.754</span> -&gt; res: hello31/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] INFO com.example.study.LoadTest - idx: <span class="number">63</span>, Elapsed: <span class="number">2.755</span> -&gt; res: hello63/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] INFO com.example.study.LoadTest - idx: <span class="number">19</span>, Elapsed: <span class="number">2.755</span> -&gt; res: hello19/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] INFO com.example.study.LoadTest - idx: <span class="number">62</span>, Elapsed: <span class="number">2.756</span> -&gt; res: hello62/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.755</span></span><br></pre></td></tr></table></figure>
<p>스레드를 확인해보면 다음과 같이 tomcat 스레드 1개, netty가 non blocking I/O를 사용하는데 필요로 하는 몇개의 스레드가 추가된 것 말고는 스레드 수가 크게 증가하지 않은것을 확인할 수 있습니다.<br>
<img src="/images/post/2019-04-13/netty_nio_result.png" alt="async rest template result"></p>
<h1 id="deferredresult">DeferredResult</h1>
<p>이전 포스팅에서 살펴 보았던 <strong>DeferredResult를 사용하면 AsyncRestTemplate을 사용하여 외부 서비스를 호출한 후, 그 결과를 다시 이용해 클라이언트의 요청에 응답하는 추가 로직 부분을 작성할 수 있습니다.</strong></p>
<p>컨트롤러에서 DeferredResult 오브젝트를 반환하는 시점에는 바로 응답이 가지 않고, 추후 해당 DeferredResult 오브젝트에 값을 set(setResult, setErrorResult) 해줄 때, 클라이언트에게 응답이 가게 됩니다. 이를 이용하려면 ListenableFuture에 콜백을 추가해 해당 콜백 로직 안에서 결과를 이용해 DeferredResult 오브젝트의 set 메서드를 호출하면 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 오브젝트를 만들어서 컨트롤러에서 리턴하면 언제가 될지 모르지만 언제인가 DeferredResult에 값을 써주면</span></span><br><span class="line">            <span class="comment">// 그 값을 응답으로 사용</span></span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">            f1.addCallback(s -&gt; &#123;</span><br><span class="line">                dr.setResult(s.getBody() + <span class="string">"/work"</span>);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                dr.setErrorResult(e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>외부 서비스의 응답을 받아 “/work” 문자열이 추가되어 클라이언트에 전달된것을 확인할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] INFO com.example.study.LoadTest - idx: <span class="number">33</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello33/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] INFO com.example.study.LoadTest - idx: <span class="number">79</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello79/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] INFO com.example.study.LoadTest - idx: <span class="number">80</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello80/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] INFO com.example.study.LoadTest - idx: <span class="number">9</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello9/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] INFO com.example.study.LoadTest - idx: <span class="number">60</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello60/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.518</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] INFO com.example.study.LoadTest - idx: <span class="number">98</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello98/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.518</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.346</span></span><br></pre></td></tr></table></figure>
<h1 id="중첩된-remote-service-사용">중첩된 Remote Service 사용</h1>
<p>이번에는 외부 서비스를 하나 더 추가해보겠습니다. 외부 서비스의 요청에 대한 결과를 다시 다른 서비스를 호출하는 요청의 파라미터로 사용하면서 콜백의 구조가 복잡해지는 문제가 생기게 되었습니다. 이런 문제를 <strong>콜백 헬</strong>이라고 합니다.</p>
<p>다음번 포스팅에서는 콜백 헬을 해결할 수 있는 방법에 대해서 알아보도록 하겠습니다.</p>
<h2 id="remote-application">Remote Application</h2>
<p>&quot;/service2&quot;를 추가합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service2"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service2</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service2"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 하나의 프로젝트에서 2개의 스프링 애플리케이션을 띄우기 위해 외부 서비스 역할을 하는 RemoteApplication은</span></span><br><span class="line">        <span class="comment">// application.properties가 아닌 별도의 프로퍼티를 이용하도록 직접 설정한다.</span></span><br><span class="line">        System.setProperty(<span class="string">"server.port"</span>, <span class="string">"8081"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"server.tomcat.max-threads"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        SpringApplication.run(RemoteApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="main-application">Main Application</h2>
<p>&quot;/service&quot;를 호출한 결과를 이용해 &quot;/service2&quot;를 호출하도록 합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 오브젝트를 만들어서 컨트롤러에서 리턴하면 언제가 될지 모르지만 언제인가 DeferredResult에 값을 써주면</span></span><br><span class="line">            <span class="comment">// 그 값을 응답으로 사용</span></span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>, String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">            f1.addCallback(s -&gt; &#123;</span><br><span class="line">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity(<span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>, String.class, s.getBody());</span><br><span class="line">                f2.addCallback(s2 -&gt; &#123;</span><br><span class="line">                    dr.setResult(s2.getBody());</span><br><span class="line">                &#125;, e -&gt; &#123;</span><br><span class="line">                    dr.setErrorResult(e.getMessage());</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                dr.setErrorResult(e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="결과-확인">결과 확인</h2>
<p>100개의 클라이언트 요청을 처리하는데 약 4.3초의 시간이 걸렸습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.904</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.904</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] INFO com.example.study.LoadTest - idx: <span class="number">17</span>, Elapsed: <span class="number">4.338</span> -&gt; res: hello17/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] INFO com.example.study.LoadTest - idx: <span class="number">87</span>, Elapsed: <span class="number">4.337</span> -&gt; res: hello87/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] INFO com.example.study.LoadTest - idx: <span class="number">14</span>, Elapsed: <span class="number">4.339</span> -&gt; res: hello14/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] INFO com.example.study.LoadTest - idx: <span class="number">74</span>, Elapsed: <span class="number">4.338</span> -&gt; res: hello74/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] INFO com.example.study.LoadTest - idx: <span class="number">60</span>, Elapsed: <span class="number">4.339</span> -&gt; res: hello60/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] INFO com.example.study.LoadTest - idx: <span class="number">38</span>, Elapsed: <span class="number">4.34</span> -&gt; res: hello38/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] INFO com.example.study.LoadTest - idx: <span class="number">78</span>, Elapsed: <span class="number">4.34</span> -&gt; res: hello78/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.909</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.example.study.LoadTest - idx: <span class="number">5</span>, Elapsed: <span class="number">4.342</span> -&gt; res: hello5/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.909</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">4.338</span></span><br></pre></td></tr></table></figure>
                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2019/04/26/Java/java-async-3/" data-toggle="tooltip" data-placement="top" title="AsyncRestTemplate의 콜백 헬과 중복 작업 문제">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/03/31/Java/java-async-1/" data-toggle="tooltip" data-placement="top" title="자바와 스프링의 비동기 기술">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <center>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3921438651818825" data-ad-slot="3015269677"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</center>

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#thread-pool-hell"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Thread Pool Hell</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#upgrade-client-for-load-test"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Upgrade Client (For Load Test)</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#외부-서비스-호출-테스트"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">외부 서비스 호출 테스트</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#main-application"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">Main Application</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#remote-application"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">Remote Application</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#결과-확인"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">결과 확인</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#asyncresttemplate"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">AsyncRestTemplate</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#netty-non-blocking-io"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">Netty non-blocking I/O</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#deferredresult"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">DeferredResult</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#중첩된-remote-service-사용"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">중첩된 Remote Service 사용</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#remote-application"><span class="toc-nav-number">7.1.</span> <span class="toc-nav-text">Remote Application</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#main-application"><span class="toc-nav-number">7.2.</span> <span class="toc-nav-text">Main Application</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#결과-확인"><span class="toc-nav-number">7.3.</span> <span class="toc-nav-text">결과 확인</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Java" title="Java">Java</a>
                        
                          <a class="tag" href="/tags/#Async" title="Async">Async</a>
                        
                          <a class="tag" href="/tags/#DeferredResult" title="DeferredResult">DeferredResult</a>
                        
                          <a class="tag" href="/tags/#RestTemplate" title="RestTemplate">RestTemplate</a>
                        
                          <a class="tag" href="/tags/#AsyncRestTemplate" title="AsyncRestTemplate">AsyncRestTemplate</a>
                        
                          <a class="tag" href="/tags/#Netty" title="Netty">Netty</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>




<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "https-jongmin92-github-io";
    var disqus_identifier = "https://jongmin92.github.io/2019/04/13/Java/java-async-2/";
    var disqus_url = "https://jongmin92.github.io/2019/04/13/Java/java-async-2/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'left',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: 0.6em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/jongmin.kim.7796420" rel="external nofollow noopener noreferrer">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://github.com/jongmin92" rel="external nofollow noopener noreferrer">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; KimJongMin 2020 
                    <br>
                    Theme by <a href="http://huangxuan.me" rel="external nofollow noopener noreferrer" target="_blank">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://beantech.org" rel="external nofollow noopener noreferrer" target="_blank">BeanTech</a> | 
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://jongmin92.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-90389042-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async></script>
<!-- Image to hack wechat -->
<img src="https://jongmin92.github.io/images/etc/icon_wechat.png" width="0" height="0">
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
