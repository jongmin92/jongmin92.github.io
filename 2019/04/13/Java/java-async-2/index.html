<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">

<meta name="generator" content="Hexo 3.9.0">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>비동기 RestTemplate과 비동기 MVC/Serlvet - 92Hz</title>

<!-- For SEO -->
<link rel="canonical" href="https://jongmin92.github.io/2019/04/13/java/java-async-2/">


    <meta name="description" content="해당 포스팅은 토비님의 토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 비동기 RestTemplate과 비동기 MVC/Serlvet 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다. 실습 코드들은 IntelliJ를 이용해 SpringBoot 2.1.3.RELEASE 버전 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행">
<meta name="keywords" content="Java,Async,DeferredResult,RestTemplate,AsyncRestTemplate,Netty">
<meta property="og:type" content="article">
<meta property="og:title" content="비동기 RestTemplate과 비동기 MVC&#x2F;Serlvet">
<meta property="og:url" content="https://jongmin92.github.io/2019/04/13/Java/java-async-2/index.html">
<meta property="og:site_name" content="92Hz">
<meta property="og:description" content="해당 포스팅은 토비님의 토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 비동기 RestTemplate과 비동기 MVC/Serlvet 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다. 실습 코드들은 IntelliJ를 이용해 SpringBoot 2.1.3.RELEASE 버전 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행">
<meta property="og:locale" content="ko">
<meta property="og:image" content="https://jongmin92.github.io/images/og_image.png">
<meta property="og:updated_time" content="2020-03-20T17:24:34.843Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="비동기 RestTemplate과 비동기 MVC&#x2F;Serlvet">
<meta name="twitter:description" content="해당 포스팅은 토비님의 토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 비동기 RestTemplate과 비동기 MVC/Serlvet 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다. 실습 코드들은 IntelliJ를 이용해 SpringBoot 2.1.3.RELEASE 버전 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행">
<meta name="twitter:image" content="https://jongmin92.github.io/images/og_image.png">





<link rel="alternative" href="rss2.xml" title="비동기 RestTemplate과 비동기 MVC/Serlvet" type="application/atom+xml">



<link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90389042-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-90389042-1');
</script>

    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.png" alt="비동기 RestTemplate과 비동기 MVC/Serlvet" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="/tags">Tags</a>
                
                <a class="navbar-item" href="/about">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="external nofollow noopener noreferrer" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="카탈로그" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="검색" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-13T14:24:00.000Z">2019-04-13</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Programming/">Programming</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Programming/Java/">Java</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    37분 읽기 (대략 5578 단어)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                비동기 RestTemplate과 비동기 MVC/Serlvet
            
        </h1>
        <div class="content">
            <p>해당 포스팅은 토비님의 <strong><a href="https://www.youtube.com/watch?v=ExUfZkh7Puk" rel="external nofollow noopener noreferrer" target="_blank">토비의 봄 TV 9회 스프링 리액티브 프로그래밍 (5) 비동기 RestTemplate과 비동기 MVC/Serlvet</a></strong> 라이브 코딩을 보며 따라했던 실습 내용을 바탕으로 정리한 글입니다.</p>
<p>실습 코드들은 IntelliJ를 이용해 <strong>SpringBoot 2.1.3.RELEASE 버전</strong> 기반으로 프로젝트를 생성 후(web, lombok 포함) 진행했습니다.</p>
<h1 id="thread-pool-hell"><a href="#Thread-Pool-Hell" class="headerlink" title="Thread Pool Hell"></a>Thread Pool Hell</h1><p><strong><a href="https://jongmin92.github.io/2019/03/31/Java/java-async-1/#servlet-async">스프링의 비동기 기술</a></strong> 을 이용해 클라이언트로부터 요청을 받은 후 실제 작업은 작업 스레드 풀에 위임하고 현재의 서블릿 스레드는 서블릿 스레드 풀에 반환 후, 다음 요청이 들어올 경우 바로 사용할 수 있게 효율적으로 처리하도록 만들었습니다.<br>그러나 아직 문제가 있습니다. </p>
<p>아주 빠르게 무언가를 계산하고 해당 처리를 끝내는 경우라면 굳이 비동기 MVC(서블릿)를 사용하지 않아도 문제가 없지만, <strong>하나의 요청에 대한 처리를 수행하면서 외부의 서비스들을 호출하는 작업이 많이 있는 경우, 문제는 단순히 비동기를 서블릿을 사용하는 것만으로 해결할 수 없는 경우가 많이 있습니다.</strong> (서블릿 요청은 바로 사용 가능하더라도 워커 스레드가 I/O 같은 작업으로 인해 블록되기 때문입니다.)</p>
<p><strong><code>Thread Pool Hell</code>이란 풀 안에 있는 스레드에 대한 사용 요청이 급격하게 증가해 추가적인 요청이 들어올 때, 사용 가능한 스레드 풀의 스레드가 없기 때문에 대기 상태에 빠져 요청에 대한 응답이 느려지게 되는 상태를 말합니다.</strong><br><img src="/images/post/2019-04-13/thread_pool_hell.png" alt="thread pool hell"></p>
<p>최근 서비스들은 아래의 그럼처럼 하나의 요청을 처리함에 있어 다른 서버로의 요청(Network I/O)이 많아졌습니다. 조금전 설명한 것처럼 비동기 서블릿을 사용하더라도 하나의 요청을 처리하는 동안 하나의 작업(워커) 스레드는 그 시간동안 대기상태에 빠지게 되어 결국에는 스레드 풀의 가용성이 떨어지게 됩니다. 이번 포스팅에서는 해당 문제를 해결해가는 과정을 다루고 있습니다.</p>
<p><img src="/images/post/2019-04-13/service_oriented_architecture.png" alt="service oriented architecture"></p>
<h1 id="upgrade-client-for-load-test"><a href="#Upgrade-Client-For-Load-Test" class="headerlink" title="Upgrade Client (For Load Test)"></a>Upgrade Client (For Load Test)</h1><p>지난 번에 작성했던 Client를 조금 수정하도록 합니다. 기존의 Client는 100개의 스레드를 순차적으로 만들면서 서버로의 Request를 만들었던 문제가 있었습니다. 이제는 100개의 스레드를 만들고 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/CyclicBarrier.html" rel="external nofollow noopener noreferrer" target="_blank">CyclicBarrier</a>를 이용해 100개의 스레드에서 동시에 Request를 만들도록 변경해보겠습니다. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException </span>&#123;</span><br><span class="line">        ExecutorService es = Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        String url = <span class="string">"http://localhost:8080/rest?idx=&#123;idx&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">101</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// submit이 받는 callable은 return을 가질 수 있으며, exception도 던질 수 있다.</span></span><br><span class="line">            es.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">int</span> idx = counter.addAndGet(<span class="number">1</span>);</span><br><span class="line">                log.info(<span class="string">"Thread &#123;&#125;"</span>, idx);</span><br><span class="line">                barrier.await();</span><br><span class="line"></span><br><span class="line">                StopWatch sw = <span class="keyword">new</span> StopWatch();</span><br><span class="line">                sw.start();</span><br><span class="line"></span><br><span class="line">                String res = rt.getForObject(url, String.class, idx);</span><br><span class="line"></span><br><span class="line">                sw.stop();</span><br><span class="line">                log.info(<span class="string">"idx: &#123;&#125;, Elapsed: &#123;&#125; -&gt; res: &#123;&#125;"</span>, idx, sw.getTotalTimeSeconds(), res);</span><br><span class="line">                <span class="comment">// IDE가 funtional interface가 callable임을 인식할 수 있도록 의미없는 return을 넣어준다.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// await을 만난 스레드가 101번째가 될 때, 모든 스레드들도 await에서 풀려나 이후 로직을 수행한다. </span></span><br><span class="line">        <span class="comment">// 메인 스레드 1개, Executors.newFixedThreadPool로 생성한 스레드 100개</span></span><br><span class="line">        barrier.await();</span><br><span class="line">        StopWatch main = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        main.start();</span><br><span class="line"></span><br><span class="line">        es.shutdown();</span><br><span class="line">        <span class="comment">// 지정된 시간이 타임아웃 걸리기 전이라면 대기작업이 진행될 때까지 기다린다.</span></span><br><span class="line">        <span class="comment">// (100초안에 작업이 끝날때까지 기다리거나, 100초가 초과되면 종료)</span></span><br><span class="line">        es.awaitTermination(<span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line">        main.stop();</span><br><span class="line">        log.info(<span class="string">"Total: &#123;&#125;"</span>, main.getTotalTimeSeconds());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="외부-서비스-호출-테스트"><a href="#외부-서비스-호출-테스트" class="headerlink" title="외부 서비스 호출 테스트"></a>외부 서비스 호출 테스트</h1><p>클라이언트의 요청을 받아 외부 서비스를 호출하고 해당 결과를 이용해서 응답을 돌려주는 테스트를 진행합니다. 테스트를 진행하기 위해서는 2개의 스프링 애플리케이션이 필요합니다. 2개의 스프링 애플리케이션의 설정은 다음과 같습니다.</p>
<ul>
<li>Main Application<ul>
<li>port: 8080</li>
<li>tomcat-max-thread-count: 1</li>
</ul>
</li>
<li>Remote Application <ul>
<li>port: 8081</li>
<li>tomcat-max-thread-count: 1000</li>
</ul>
</li>
</ul>
<h2 id="main-application"><a href="#Main-Application" class="headerlink" title="Main Application"></a>Main Application</h2><p>먼저 하나의 스프링 애플리케이션에 컨트롤러를 하나 준비합니다. 이 컨트롤러는 클라이언트로부터 요청을 받아 해당 요청으로부터 받은 값을 이용해 다른 외부 서비스(<a href="http://localhost:8081/service?req={req})를" rel="external nofollow noopener noreferrer" target="_blank">http://localhost:8081/service?req={req})를</a> 호출합니다.</p>
<p><strong>결국 해당 서블릿은 클라이언트 요청을 처리하면서 외부 서비스로의 Networking I/O 작업을 수행하기 때문에 외부 서비스로부터의 요청에 대한 응답을 받기 전까지는 blocking 상태가 됩니다.</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        RestTemplate rt = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            String res = rt.getForObject(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);        </span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>application.properties</code> 파일에서 다음과 같이 Tomcat의 스레드 개수를 1개로 설정합니다.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.tomcat.max-threads=1</span></span><br></pre></td></tr></table></figure></p>
<h2 id="remote-application"><a href="#Remote-Application" class="headerlink" title="Remote Application"></a>Remote Application</h2><p>다른 하나의 스프링 애플리케이션을 생성하고 이전에 만들었던 스프링 애플리케이션의 컨트롤러 내부에서 만들었던 요청을 받아 처리할 수 있도록 컨트롤러 추가합니다. 8080 포트가 아닌 8081 포트를 사용하고 tomcat 스레드를 1000개로 설정합니다. RemoteApplication은 application.properties의 값을 사용하게 하지 않고 직접 프로퍼티를 설정해줍니다. </p>
<p>아래와 같이 설정하면 Intellij를 이용해서 하나의 프로젝트에서 2개의 스프링 애플리케이션을 실행할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 하나의 프로젝트에서 2개의 스프링 애플리케이션을 띄우기 위해 외부 서비스 역할을 하는 RemoteApplication은</span></span><br><span class="line">        <span class="comment">// application.properties가 아닌 별도의 프로퍼티를 이용하도록 직접 설정한다.</span></span><br><span class="line">        System.setProperty(<span class="string">"server.port"</span>, <span class="string">"8081"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"server.tomcat.max-threads"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        SpringApplication.run(RemoteApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="결과-확인"><a href="#결과-확인" class="headerlink" title="결과 확인"></a>결과 확인</h2><p>MainApplication과 RemoteApplication을 각각 실행하고 Client를 이용한 테스트 결과는 다음과 같습니다.<br>100개의 클라이언트 요청을 처리하는데 0.4초 정도의 시간이 걸렸습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.539</span> [pool-<span class="number">1</span>-thread-<span class="number">40</span>] INFO com.example.study.LoadTest - idx: <span class="number">40</span>, Elapsed: <span class="number">0.4</span> -&gt; res: hello40/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.541</span> [pool-<span class="number">1</span>-thread-<span class="number">77</span>] INFO com.example.study.LoadTest - idx: <span class="number">77</span>, Elapsed: <span class="number">0.401</span> -&gt; res: hello77/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.543</span> [pool-<span class="number">1</span>-thread-<span class="number">48</span>] INFO com.example.study.LoadTest - idx: <span class="number">48</span>, Elapsed: <span class="number">0.403</span> -&gt; res: hello48/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.545</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.545</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.546</span> [pool-<span class="number">1</span>-thread-<span class="number">8</span>] INFO com.example.study.LoadTest - idx: <span class="number">8</span>, Elapsed: <span class="number">0.407</span> -&gt; res: hello8/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] INFO com.example.study.LoadTest - idx: <span class="number">33</span>, Elapsed: <span class="number">0.409</span> -&gt; res: hello33/service</span><br><span class="line"><span class="number">01</span>:<span class="number">54</span>:<span class="number">27.548</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">0.407</span></span><br></pre></td></tr></table></figure></p>
<p>이번에는 RemoteApplication의 요청 처리 부분에 2초간 Thread sleep을 주고 다시 한 번 클라이언트를 이용해 테스트를 진행해봅니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RemoteApplication</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">return</span> req + <span class="string">"/service"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Thread sleep을 추가하고 다시 테스트를 해보면 결과는 다음과 같습니다. 100개의 요청을 약 0.4초만에 모두 처리하던 이전과 달리 매 요청을 처리하는데 약 2초의 시간이 증가하고 있습니다. 결국 마지막 요청은 약 2 * 100 = 200초 후에서야 응답을 받을 수 있기 때문에 모든 요청에 대한 처리는 200초 정도 걸릴 것 입니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.056</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.058</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">22.061</span> [pool-<span class="number">1</span>-thread-<span class="number">32</span>] INFO com.example.study.LoadTest - idx: <span class="number">32</span>, Elapsed: <span class="number">2.233</span> -&gt; res: hello32/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">24.060</span> [pool-<span class="number">1</span>-thread-<span class="number">56</span>] INFO com.example.study.LoadTest - idx: <span class="number">56</span>, Elapsed: <span class="number">4.231</span> -&gt; res: hello56/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">26.068</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] INFO com.example.study.LoadTest - idx: <span class="number">93</span>, Elapsed: <span class="number">6.238</span> -&gt; res: hello93/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">28.077</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] INFO com.example.study.LoadTest - idx: <span class="number">31</span>, Elapsed: <span class="number">8.249</span> -&gt; res: hello31/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.081</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.082</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">30.082</span> [pool-<span class="number">1</span>-thread-<span class="number">20</span>] INFO com.example.study.LoadTest - idx: <span class="number">20</span>, Elapsed: <span class="number">10.254</span> -&gt; res: hello20/service</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">02</span>:<span class="number">25</span>:<span class="number">32.089</span> [pool-<span class="number">1</span>-thread-<span class="number">46</span>] INFO com.example.study.LoadTest - idx: <span class="number">46</span>, Elapsed: <span class="number">12.26</span> -&gt; res: hello46/service</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>이런 결과가 나오게 된 이유는 클라이언트로부터의 요청을 받아 처리하는 Main Application의 tomcat thread가 1개이고, 1개의 서블릿 스레드를 이용해 클라이언트의 요청을 처리하는 과정에서 Remote Application에 대한 요청(Network I/O)에서 응답을 받기까지 약 2초간 스레드가 block되기 때문입니다.</p>
<h1 id="asyncresttemplate"><a href="#AsyncRestTemplate" class="headerlink" title="AsyncRestTemplate"></a>AsyncRestTemplate</h1><p><strong>위의 문제는 MainApplication의 tomcat 스레드는 클라이언트의 요청을 처리하며 외부 서비스(RemoteApplication)로 요청(Network I/O)을 보낸 후, 응답이 올 때까지 대기하고 있는 상태라는 점입니다. 해당 시간동안 CPU는 아무 일을 처리하지 않기때문에 자원이 소모되고 있습니다.</strong></p>
<p><strong>이 문제를 해결하기 위해서는 API를 호출하는 작업을 비동기적으로 바꿔야합니다. tomcat 스레드는 요청에 대한 작업을 다 끝내기 전에 반환을 해서 바로 다음 요청을 처리하도록 사용합니다. 그리고 외부 서비스로부터 실제 결과를 받고 클라이언트의 요청에 응답을 보내기 위해서는 새로운 스레드를 할당 받아 사용합니다.</strong> (외부 서비스로부터 실제 결과를 받고 클라이언트에 응답을 보내기 위해서는 새로운 스레드를 할당 받아야 하지만, 외부 API를 호출하는 동안은 스레드(tomcat) 자원을 낭비하고 싶지 않다는 것이 목적이다.)</p>
<p>스프링 3.x 버전에서는 이 문제를 간단히 해결하기 어려웠지만 스프링 4 부터 제공하는 <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/AsyncRestTemplate.html" rel="external nofollow noopener noreferrer" target="_blank">AsyncRestTemplate</a>을 사용하면 이 문제를 쉽게 해결할 수 있습니다. <strong>AsyncRestTemplate은 비동기 클라이언트를 제공하는 클래스이며 ListenableFuture를 반환합니다. 스프링은 컨트롤러에서 ListenableFuture를 리턴하면 해당 스레드는 즉시 반납하고, 스프링 MVC가 자동으로 등록해준 콜백에 의해 결과가 처리됩니다.</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="keyword">public</span> ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; rest(<span class="keyword">int</span> idx) &#123;</span><br><span class="line">            <span class="keyword">return</span> rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>실행 결과를 살펴보면 100개의 요청을 동시에 처리하는데 약 2.6초의 시간이 걸렸습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.088</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.089</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.089</span> [pool-<span class="number">1</span>-thread-<span class="number">4</span>] INFO com.example.study.LoadTest - idx: <span class="number">4</span>, Elapsed: <span class="number">2.658</span> -&gt; res: hello4/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.090</span> [pool-<span class="number">1</span>-thread-<span class="number">44</span>] INFO com.example.study.LoadTest - idx: <span class="number">44</span>, Elapsed: <span class="number">2.659</span> -&gt; res: hello44/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.091</span> [pool-<span class="number">1</span>-thread-<span class="number">93</span>] INFO com.example.study.LoadTest - idx: <span class="number">93</span>, Elapsed: <span class="number">2.658</span> -&gt; res: hello93/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.095</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.096</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.096</span> [pool-<span class="number">1</span>-thread-<span class="number">66</span>] INFO com.example.study.LoadTest - idx: <span class="number">66</span>, Elapsed: <span class="number">2.664</span> -&gt; res: hello66/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.098</span> [pool-<span class="number">1</span>-thread-<span class="number">16</span>] INFO com.example.study.LoadTest - idx: <span class="number">16</span>, Elapsed: <span class="number">2.667</span> -&gt; res: hello16/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.101</span> [pool-<span class="number">1</span>-thread-<span class="number">57</span>] INFO com.example.study.LoadTest - idx: <span class="number">57</span>, Elapsed: <span class="number">2.669</span> -&gt; res: hello57/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.104</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.104</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.example.study.LoadTest - idx: <span class="number">2</span>, Elapsed: <span class="number">2.674</span> -&gt; res: hello2/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.105</span> [pool-<span class="number">1</span>-thread-<span class="number">15</span>] INFO com.example.study.LoadTest - idx: <span class="number">15</span>, Elapsed: <span class="number">2.674</span> -&gt; res: hello15/service</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">49.106</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.673</span></span><br></pre></td></tr></table></figure></p>
<p>클라이언트의 요청이 들어 올 때, MainApplication의 스레드 상태를 살펴보면, tomcat 스레드는 그대로 1개 입니다.(http-nio-8080-exec-1) 그러나 비동기 작업을 처리하기 위해서 순간적으로 백그라운드에 100개의 스레드 새로 생성되는것을 확인할 수 있습니다.<br><img src="/images/post/2019-04-13/async_rest_template_result.png" alt="async rest template result"></p>
<h1 id="netty-non-blocking-io"><a href="#Netty-non-blocking-I-O" class="headerlink" title="Netty non-blocking I/O"></a>Netty non-blocking I/O</h1><p>지금까지 Tomcat의 스레드가 1개이지만 요청을 비동기적으로 처리함으로써 Tomcat의 스레드는 바로 반환이되어 다시 그 후의 요청에 Tomcat의 스레드를 이용해 요청을 받을 수 있었습니다. 그러나 결과적으로는 실제 비동기 요청을 처리하는 스레드는 요청의 수 만큼 계속 생성되는 것을 확인할 수 있었습니다.</p>
<p>이번에는 이렇게 <strong>비동기 요청을 처리하는 스레드의 수도 Netty의 non blocking I/O를 이용함으로써 비동기 요청을 처리하는 스레드도 줄여보고자 합니다.</strong> 그러면 결과적으로 tomcat의 스레드 1개, netty의 non blocking I/O를 이용하기위한 필요한 스레드의 수만큼만 생성되어 클라이언트의 요청을 모두 처리할 수 있을 것 입니다.</p>
<p>먼저 netty의 dependency를 build.gradle 혹은 pom.xml에 추가합니다. 저는 build.gradle에 의존성을 추가해 주었습니다.<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    implementation <span class="string">'io.netty:netty-all:4.0.4.Final'</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AsyncRestTemplate이 netty의 Netty4ClientHttpRequestFactory를 이용할 수 있도록 다음과 같이 설정합니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="keyword">public</span> ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; rest(<span class="keyword">int</span> idx) &#123;</span><br><span class="line">            <span class="keyword">return</span> rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>다시 서버를 띄우고 테스트를 해보면 클라이언트의 요청을 전부 처리하는데 걸린 시간은 약 2.7초로 이전과 큰 차이가 없습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.958</span> [pool-<span class="number">1</span>-thread-<span class="number">65</span>] INFO com.example.study.LoadTest - idx: <span class="number">65</span>, Elapsed: <span class="number">2.744</span> -&gt; res: hello65/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">59</span>] INFO com.example.study.LoadTest - idx: <span class="number">59</span>, Elapsed: <span class="number">2.751</span> -&gt; res: hello59/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.964</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.965</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.965</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] INFO com.example.study.LoadTest - idx: <span class="number">14</span>, Elapsed: <span class="number">2.752</span> -&gt; res: hello14/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.968</span> [pool-<span class="number">1</span>-thread-<span class="number">31</span>] INFO com.example.study.LoadTest - idx: <span class="number">31</span>, Elapsed: <span class="number">2.754</span> -&gt; res: hello31/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">63</span>] INFO com.example.study.LoadTest - idx: <span class="number">63</span>, Elapsed: <span class="number">2.755</span> -&gt; res: hello63/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.969</span> [pool-<span class="number">1</span>-thread-<span class="number">19</span>] INFO com.example.study.LoadTest - idx: <span class="number">19</span>, Elapsed: <span class="number">2.755</span> -&gt; res: hello19/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [pool-<span class="number">1</span>-thread-<span class="number">62</span>] INFO com.example.study.LoadTest - idx: <span class="number">62</span>, Elapsed: <span class="number">2.756</span> -&gt; res: hello62/service</span><br><span class="line"><span class="number">18</span>:<span class="number">24</span>:<span class="number">49.970</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.755</span></span><br></pre></td></tr></table></figure></p>
<p>스레드를 확인해보면 다음과 같이 tomcat 스레드 1개, netty가 non blocking I/O를 사용하는데 필요로 하는 몇개의 스레드가 추가된 것 말고는 스레드 수가 크게 증가하지 않은것을 확인할 수 있습니다.<br><img src="/images/post/2019-04-13/netty_nio_result.png" alt="async rest template result"></p>
<h1 id="deferredresult"><a href="#DeferredResult" class="headerlink" title="DeferredResult"></a>DeferredResult</h1><p>이전 포스팅에서 살펴 보았던 <strong>DeferredResult를 사용하면 AsyncRestTemplate을 사용하여 외부 서비스를 호출한 후, 그 결과를 다시 이용해 클라이언트의 요청에 응답하는 추가 로직 부분을 작성할 수 있습니다.</strong></p>
<p>컨트롤러에서 DeferredResult 오브젝트를 반환하는 시점에는 바로 응답이 가지 않고, 추후 해당 DeferredResult 오브젝트에 값을 set(setResult, setErrorResult) 해줄 때, 클라이언트에게 응답이 가게 됩니다. 이를 이용하려면 ListenableFuture에 콜백을 추가해 해당 콜백 로직 안에서 결과를 이용해 DeferredResult 오브젝트의 set 메서드를 호출하면 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 오브젝트를 만들어서 컨트롤러에서 리턴하면 언제가 될지 모르지만 언제인가 DeferredResult에 값을 써주면</span></span><br><span class="line">            <span class="comment">// 그 값을 응답으로 사용</span></span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>,</span><br><span class="line">                    String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">            f1.addCallback(s -&gt; &#123;</span><br><span class="line">                dr.setResult(s.getBody() + <span class="string">"/work"</span>);</span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                dr.setErrorResult(e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>외부 서비스의 응답을 받아 “/work” 문자열이 추가되어 클라이언트에 전달된것을 확인할 수 있습니다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.514</span> [pool-<span class="number">1</span>-thread-<span class="number">33</span>] INFO com.example.study.LoadTest - idx: <span class="number">33</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello33/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">79</span>] INFO com.example.study.LoadTest - idx: <span class="number">79</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello79/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.515</span> [pool-<span class="number">1</span>-thread-<span class="number">80</span>] INFO com.example.study.LoadTest - idx: <span class="number">80</span>, Elapsed: <span class="number">2.345</span> -&gt; res: hello80/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.516</span> [pool-<span class="number">1</span>-thread-<span class="number">9</span>] INFO com.example.study.LoadTest - idx: <span class="number">9</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello9/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] INFO com.example.study.LoadTest - idx: <span class="number">60</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello60/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.517</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.518</span> [pool-<span class="number">1</span>-thread-<span class="number">98</span>] INFO com.example.study.LoadTest - idx: <span class="number">98</span>, Elapsed: <span class="number">2.347</span> -&gt; res: hello98/service/work</span><br><span class="line"><span class="number">18</span>:<span class="number">38</span>:<span class="number">23.518</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">2.346</span></span><br></pre></td></tr></table></figure></p>
<h1 id="중첩된-remote-service-사용"><a href="#중첩된-Remote-Service-사용" class="headerlink" title="중첩된 Remote Service 사용"></a>중첩된 Remote Service 사용</h1><p>이번에는 외부 서비스를 하나 더 추가해보겠습니다. 외부 서비스의 요청에 대한 결과를 다시 다른 서비스를 호출하는 요청의 파라미터로 사용하면서 콜백의 구조가 복잡해지는 문제가 생기게 되었습니다. 이런 문제를 <strong>콜백 헬</strong>이라고 합니다.</p>
<p>다음번 포스팅에서는 콜백 헬을 해결할 수 있는 방법에 대해서 알아보도록 하겠습니다.</p>
<h2 id="remote-application"><a href="#Remote-Application-1" class="headerlink" title="Remote Application"></a>Remote Application</h2><p>“/service2”를 추가합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteController</span> </span>&#123;</span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/service2"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">service2</span><span class="params">(String req)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="keyword">return</span> req + <span class="string">"/service2"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 하나의 프로젝트에서 2개의 스프링 애플리케이션을 띄우기 위해 외부 서비스 역할을 하는 RemoteApplication은</span></span><br><span class="line">        <span class="comment">// application.properties가 아닌 별도의 프로퍼티를 이용하도록 직접 설정한다.</span></span><br><span class="line">        System.setProperty(<span class="string">"server.port"</span>, <span class="string">"8081"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"server.tomcat.max-threads"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        SpringApplication.run(RemoteApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="main-application"><a href="#Main-Application-1" class="headerlink" title="Main Application"></a>Main Application</h2><p>“/service”를 호출한 결과를 이용해 “/service2”를 호출하도록 합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">        <span class="comment">// asynchronous + netty non-blocking</span></span><br><span class="line">        AsyncRestTemplate rt = <span class="keyword">new</span> AsyncRestTemplate(<span class="keyword">new</span> Netty4ClientHttpRequestFactory(<span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">rest</span><span class="params">(<span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 오브젝트를 만들어서 컨트롤러에서 리턴하면 언제가 될지 모르지만 언제인가 DeferredResult에 값을 써주면</span></span><br><span class="line">            <span class="comment">// 그 값을 응답으로 사용</span></span><br><span class="line">            DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f1 = rt.getForEntity(<span class="string">"http://localhost:8081/service?req=&#123;req&#125;"</span>, String.class, <span class="string">"hello"</span> + idx);</span><br><span class="line">            f1.addCallback(s -&gt; &#123;</span><br><span class="line">                ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; f2 = rt.getForEntity(<span class="string">"http://localhost:8081/service2?req=&#123;req&#125;"</span>, String.class, s.getBody());</span><br><span class="line">                f2.addCallback(s2 -&gt; &#123;</span><br><span class="line">                    dr.setResult(s2.getBody());</span><br><span class="line">                &#125;, e -&gt; &#123;</span><br><span class="line">                    dr.setErrorResult(e.getMessage());</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;, e -&gt; &#123;</span><br><span class="line">                dr.setErrorResult(e.getMessage());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="결과-확인"><a href="#결과-확인-1" class="headerlink" title="결과 확인"></a>결과 확인</h2><p>100개의 클라이언트 요청을 처리하는데 약 4.3초의 시간이 걸렸습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.904</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.904</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">17</span>] INFO com.example.study.LoadTest - idx: <span class="number">17</span>, Elapsed: <span class="number">4.338</span> -&gt; res: hello17/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">87</span>] INFO com.example.study.LoadTest - idx: <span class="number">87</span>, Elapsed: <span class="number">4.337</span> -&gt; res: hello87/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.905</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">14</span>] INFO com.example.study.LoadTest - idx: <span class="number">14</span>, Elapsed: <span class="number">4.339</span> -&gt; res: hello14/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.906</span> [pool-<span class="number">1</span>-thread-<span class="number">74</span>] INFO com.example.study.LoadTest - idx: <span class="number">74</span>, Elapsed: <span class="number">4.338</span> -&gt; res: hello74/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">60</span>] INFO com.example.study.LoadTest - idx: <span class="number">60</span>, Elapsed: <span class="number">4.339</span> -&gt; res: hello60/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">38</span>] INFO com.example.study.LoadTest - idx: <span class="number">38</span>, Elapsed: <span class="number">4.34</span> -&gt; res: hello38/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.907</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">78</span>] INFO com.example.study.LoadTest - idx: <span class="number">78</span>, Elapsed: <span class="number">4.34</span> -&gt; res: hello78/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG org.springframework.web.client.RestTemplate - Response <span class="number">200</span> OK</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.908</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] DEBUG org.springframework.web.client.RestTemplate - Reading to [java.lang.String] as <span class="string">"text/plain;charset=UTF-8"</span></span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.909</span> [pool-<span class="number">1</span>-thread-<span class="number">5</span>] INFO com.example.study.LoadTest - idx: <span class="number">5</span>, Elapsed: <span class="number">4.342</span> -&gt; res: hello5/service1/service2</span><br><span class="line"><span class="number">19</span>:<span class="number">25</span>:<span class="number">19.909</span> [main] INFO com.example.study.LoadTest - Total: <span class="number">4.338</span></span><br></pre></td></tr></table></figure>
        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Async/">Async</a>, <a class="has-link-grey -link" href="/tags/AsyncRestTemplate/">AsyncRestTemplate</a>, <a class="has-link-grey -link" href="/tags/DeferredResult/">DeferredResult</a>, <a class="has-link-grey -link" href="/tags/Java/">Java</a>, <a class="has-link-grey -link" href="/tags/Netty/">Netty</a>, <a class="has-link-grey -link" href="/tags/RestTemplate/">RestTemplate</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2019/04/26/Java/java-async-3/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">AsyncRestTemplate의 콜백 헬과 중복 작업 문제</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/03/31/Java/java-async-1/">
                <span class="level-item">자바와 스프링의 비동기 기술</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">댓글</h3>
        
<script>
    var disqus_config = function () {
        this.page.url = 'https://jongmin92.github.io/2019/04/13/Java/java-async-2/';
        this.page.identifier = '2019/04/13/Java/java-async-2/';
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'https-jongmin92-github-io' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </div>
</div>


<!-- For Google Adsense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3921438651818825" data-ad-slot="3015269677"></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>

</div>
                
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-3 column-right is-sticky">
    
        

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    카탈로그
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#thread-pool-hell">
        <span class="has-mr-6">1</span>
        <span>Thread Pool Hell</span>
        </a></li><li>
        <a class="is-flex" href="#upgrade-client-for-load-test">
        <span class="has-mr-6">2</span>
        <span>Upgrade Client (For Load Test)</span>
        </a></li><li>
        <a class="is-flex" href="#외부-서비스-호출-테스트">
        <span class="has-mr-6">3</span>
        <span>외부 서비스 호출 테스트</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#main-application">
        <span class="has-mr-6">3.1</span>
        <span>Main Application</span>
        </a></li><li>
        <a class="is-flex" href="#remote-application">
        <span class="has-mr-6">3.2</span>
        <span>Remote Application</span>
        </a></li><li>
        <a class="is-flex" href="#결과-확인">
        <span class="has-mr-6">3.3</span>
        <span>결과 확인</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#asyncresttemplate">
        <span class="has-mr-6">4</span>
        <span>AsyncRestTemplate</span>
        </a></li><li>
        <a class="is-flex" href="#netty-non-blocking-io">
        <span class="has-mr-6">5</span>
        <span>Netty non-blocking I/O</span>
        </a></li><li>
        <a class="is-flex" href="#deferredresult">
        <span class="has-mr-6">6</span>
        <span>DeferredResult</span>
        </a></li><li>
        <a class="is-flex" href="#중첩된-remote-service-사용">
        <span class="has-mr-6">7</span>
        <span>중첩된 Remote Service 사용</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#remote-application">
        <span class="has-mr-6">7.1</span>
        <span>Remote Application</span>
        </a></li><li>
        <a class="is-flex" href="#main-application">
        <span class="has-mr-6">7.2</span>
        <span>Main Application</span>
        </a></li><li>
        <a class="is-flex" href="#결과-확인">
        <span class="has-mr-6">7.3</span>
        <span>결과 확인</span>
        </a></li></ul></li></ul>
            </div>
        </div>
    </div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                카테고리
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Algorithm/">
            <span class="level-start">
                <span class="level-item">Algorithm</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Algorithm/BOJ/">
            <span class="level-start">
                <span class="level-item">BOJ</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Algorithm/Concept/">
            <span class="level-start">
                <span class="level-item">Concept</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Book/">
            <span class="level-start">
                <span class="level-item">Book</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Database/">
            <span class="level-start">
                <span class="level-item">Database</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/">
            <span class="level-start">
                <span class="level-item">Programming</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">95</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Programming/AWS/">
            <span class="level-start">
                <span class="level-item">AWS</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Git/">
            <span class="level-start">
                <span class="level-item">Git</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Gradle/">
            <span class="level-start">
                <span class="level-item">Gradle</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/HTML/">
            <span class="level-start">
                <span class="level-item">HTML</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">21</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/JavaScript/">
            <span class="level-start">
                <span class="level-item">JavaScript</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">15</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Linux-Ubuntu/">
            <span class="level-start">
                <span class="level-item">Linux & Ubuntu</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Node/">
            <span class="level-start">
                <span class="level-item">Node</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/RaspberryPi/">
            <span class="level-start">
                <span class="level-item">RaspberryPi</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/React-Native/">
            <span class="level-start">
                <span class="level-item">React Native</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Spring/">
            <span class="level-start">
                <span class="level-item">Spring</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">19</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Programming/Tool/">
            <span class="level-start">
                <span class="level-item">Tool</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Project/">
            <span class="level-start">
                <span class="level-item">Project</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Project/Emily/">
            <span class="level-start">
                <span class="level-item">Emily</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Tip/">
            <span class="level-start">
                <span class="level-item">Tip</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.png" alt="비동기 RestTemplate과 비동기 MVC/Serlvet" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 KimJongMin&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a> & <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="external nofollow noopener noreferrer">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("ko");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://jongmin92.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" rel="external nofollow noopener noreferrer" target="_blank">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Zurück nach oben" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="입력 하세요...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '포스트',
                PAGES: '페이지',
                CATEGORIES: '카테고리',
                TAGS: '태그',
                UNTITLED: '(제목없음)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>